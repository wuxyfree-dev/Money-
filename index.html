<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°å¦–çš„æ‹›è´¢åˆ†è´¦å°ç«™</title>

  <!-- å›¾è¡¨ï¼šChart.jsï¼ˆå…Reactï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- å¯¼å‡ºExcelï¼šSheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --card: rgba(255,255,255,.74);
      --card2: rgba(255,255,255,.62);
      --stroke: rgba(255,255,255,.46);
      --text: #5b21b6;
      --text2:#7c3aed;
      --muted:#a78bfa;
      --shadow: 0 12px 30px rgba(17, 24, 39, .08);
      --r: 28px;
      --danger:#ef4444;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: KaiTi, STKaiti, STFangsong, serif, "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji";
      color: var(--text);
      background: radial-gradient(circle at 10% 10%, #fde68a55 0 35%, transparent 36%),
                  radial-gradient(circle at 90% 20%, #fbcfe855 0 35%, transparent 36%),
                  radial-gradient(circle at 40% 100%, #fdba7455 0 40%, transparent 41%),
                  linear-gradient(135deg,#fffbeb,#fff1f2 45%,#fff7ed);
      min-height:100vh;
      padding: 18px;
    }
    .bg-emj{ position:fixed; inset:0; pointer-events:none; z-index:-1; opacity:.14; font-size:70px; }
    .bg-emj span{ position:absolute; filter: blur(.1px); }

    /* è®©æ•´ä½“æ°¸è¿œå±…ä¸­ */
    .wrap{ max-width: 1220px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; }

    .top{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 8px);
      box-shadow: var(--shadow);
      padding: 16px 18px 14px;
      position:relative;
      overflow:hidden;
    }
    .topbar{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    .top h1{ margin:0; font-size:28px; letter-spacing:.5px; font-weight: 900; }
    .top .meta{ margin-top: 10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .pill{
      background: rgba(255,255,255,.72);
      border: 1px solid var(--stroke);
      padding: 9px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 14px rgba(17,24,39,.06);
      display:flex; gap:10px; align-items:center;
      color: var(--text);
      font-size:16px;
      white-space:nowrap;
    }

    input, select, textarea, button{ font-family: inherit; color: var(--text); font-size: 16px; }

    input[type="date"], input[type="number"], input[type="text"], select, textarea{
      width:100%;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.74);
      padding: 10px 12px;
      outline:none;
      box-shadow: 0 6px 14px rgba(17,24,39,.06);
    }
    input[type="number"]{ appearance:textfield; }
    textarea{ min-height: 44px; resize: vertical; line-height:1.45; }

    button{
      border:0;
      border-radius: 18px;
      padding: 10px 14px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(17,24,39,.08);
      transition: transform .05s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:active{ transform: translateY(1px); }

    .btn-primary{ background:#7c3aed; color:white; }
    .btn-ok{ background:#10b981; color:white; }
    .btn-warn{ background:#f59e0b; color:white; }
    .btn-ghost{ background: rgba(255,255,255,.76); border:1px solid var(--stroke); color: var(--text); }
    .btn-danger{ background: var(--danger); color:white; }

    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
      background: var(--card2);
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 8px);
      padding: 10px;
      box-shadow: var(--shadow);
      align-items:center;
    }
    .nav button{ padding: 10px 14px; }
    .nav .active{ background:#7c3aed; color:#fff; }

    /* ä¸»ä½“ï¼šè‡ªé€‚åº” */
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:12px; align-items:start; width:100%; }
    #page{ width:100%; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .col{ display:flex; flex-direction:column; gap:12px; }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 8px);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* æ ‡é¢˜æ›´çªå‡º */
    .card h2{ margin:0 0 10px; font-size:24px; font-weight:900; }
    .section-title{ font-size: 24px; font-weight: 900; }

    .hint{ color: var(--text2); opacity:.82; margin: 6px 0 0; font-size: 15px; }

    .hr{ height:1px; background: rgba(255,255,255,.6); border:0; margin: 12px 0; }

    .row{ display:grid; grid-template-columns: repeat(12,1fr); gap:10px; align-items:end; }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .item{
      background: rgba(255,255,255,.76);
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 4px);
      padding: 12px;
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
    }

    .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--stroke);
      font-size: 14px;
      color: var(--text2);
      white-space:nowrap;
    }

    .mini{ font-size:14px; color: var(--muted); }

    .kpi{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-top:10px; }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2,1fr); } }

    .kpi .box{
      background: rgba(255,255,255,.76);
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 2px);
      padding: 12px;
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
    }
    .kpi .box .t{ font-size: 14px; color: var(--muted); }
    .kpi .box .v{ font-size: 20px; font-weight: 900; margin-top: 4px; color: var(--text); }

    .checkline{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border: 1px solid var(--stroke);
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
      overflow:hidden;
    }
    .checkline label{ display:flex; align-items:center; gap:10px; cursor:pointer; min-width:0; }
    .checkline input[type="checkbox"]{ width:20px; height:20px; }

    .badge{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--stroke);
      padding: 8px 10px;
      border-radius: 999px;
      display:inline-flex; gap:10px; align-items:center;
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
      color: var(--text2);
      font-size: 14px;
      white-space:nowrap;
    }

    .footer{ text-align:center; color: var(--muted); margin: 10px 0 22px; font-size: 14px; }

    /* æ”¶å…¥æ„æˆæ¨ªå‘æ¯”ä¾‹æ¡ï¼ˆé€æ˜è´¨æ„Ÿ + ä¸¥æ ¼æŒ‰widthï¼Œä¸è¢«flexæŒ¤å‹ï¼‰ */
    .stackwrap{ margin-top:8px; }
    .stackhead{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .stacklegend{ display:flex; gap:10px; flex-wrap:wrap; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot-fixed{ background: rgba(124,58,237,.5); }
    .dot-biz{ background: rgba(16,185,129,.45); }
    .dot-other{ background: rgba(245,158,11,.45); }

    .stackbar{
      position:relative;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      border-radius: 999px;
      height: 24px;
      overflow:hidden;
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
      display:flex;
    }
    .stackbar > div{ height:100%; display:flex; align-items:center; justify-content:center; min-width:0; flex: 0 0 auto; }
    .stackbar span{ font-size:12px; color:#111827; opacity:.78; white-space:nowrap; padding: 0 6px; text-overflow:ellipsis; overflow:hidden; }

    .seg-fixed{ background: rgba(124,58,237,.24); backdrop-filter: blur(6px); }
    .seg-biz{ background: rgba(16,185,129,.22); backdrop-filter: blur(6px); }
    .seg-other{ background: rgba(245,158,11,.20); backdrop-filter: blur(6px); }

    /* æ¨¡æ€æ¡†ï¼šé€šç”¨ */
    .modal-mask{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modal{
      width: min(980px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 24px;
      box-shadow: 0 22px 60px rgba(17,24,39,.18);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.75);
    }
    .modal-title{ font-weight: 900; font-size: 18px; }
    .modal-body{ padding: 14px 16px; }

    /* æ¯”ä¾‹ç¼–è¾‘æ¨¡æ€ */
    .ratio-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    @media (max-width: 720px){ .ratio-grid{ grid-template-columns: 1fr; } }

    .ratio-cell{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 10px;
    }
    .ratio-cell .topline{ display:flex; justify-content:space-between; gap:10px; align-items:center; }

    .ratio-sum{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.75);
    }
    .ratio-sum b{ font-size: 16px; }

    /* å›¾è¡¨ï¼šå¯ç‚¹å‡»æ”¾å¤§ */
    .zoomable{ cursor: zoom-in; }

    /* æ”¶å…¥æ˜ç»†ï¼šä¸å‡ºç°æ¨ªå‘æ»šåŠ¨æ¡ï¼›è‡ªåŠ¨æ¢è¡Œæ’ç‰ˆï¼ˆæ›´é€‚åˆä½ è¿™ç§â€œå½•å…¥å‹é¡µé¢â€ï¼‰ */
    .income-line{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      overflow:visible; /* âœ… ä¸å†å‡ºç°æ¨ªå‘æ»šåŠ¨æ¡ */
      padding-bottom: 2px;
    }
    .income-field{
      min-width: 160px;
      flex: 1 1 160px;
    }
    .income-field.small{
      min-width: 120px;
      flex: 0 0 120px;
    }
    .income-field.big{
      min-width: 240px;
      flex: 2 1 240px;
    }
    .income-field.scheme{
      min-width: 280px; /* è®©â€œæ¯”ä¾‹æ–¹æ¡ˆ+æŒ‰é’®â€æ›´å®¹æ˜“åŒæ’ */
      flex: 3 1 320px;
    }

    /* æ¯”ä¾‹æ–¹æ¡ˆï¼šä¸‹æ‹‰ +ï¼ˆç¼–è¾‘/åˆ é™¤ï¼‰åŒä¸€è¡Œ */
    .scheme-inline{
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex-wrap:nowrap;
    }
    .scheme-inline select{ flex: 1 1 auto; min-width: 200px; }
    .scheme-inline button{ flex: 0 0 auto; padding:10px 12px; }

    /* æ—§çš„ actions å®¹å™¨ä¿ç•™ä½†ä¸å†éœ€è¦æ—¶ä¸ä¼šå½±å“å¸ƒå±€ */
    .income-actions{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      margin-left:auto;
      align-self:flex-end;
    }
    .income-actions{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      margin-left:auto;
      align-self:flex-end;
    }

    /* å³ä¾§ï¼šç”¨é€”/è½¬è´¦å¹¶æ’ï¼ˆæ›´ç´§å‡‘ï¼‰ */
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .split{ grid-template-columns: 1fr; } }

    /* æ”¾å¤§å›¾è¡¨æ¨¡æ€ */
    .zoom-img-wrap{ display:flex; flex-direction:column; gap:10px; }
    .zoom-img{ width:100%; height:auto; border-radius: 18px; background: rgba(17,24,39,.06); }

    /* å°è¡¨æ ¼æ ·å¼ï¼ˆç”¨äºâ€œåˆ†é…æ¸…å•â€è¡¨å¤´ï¼‰ */
    .mini-table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    .mini-table th{ text-align:left; font-size:13px; color: var(--muted); font-weight:900; padding:0 10px; }
    .mini-table td{ padding:0; }
  </style>
</head>
<body>

  <div class="bg-emj" aria-hidden="true">
    <span style="left:16px; top:18px;">ğŸ“Š</span>
    <span style="right:22px; top:34px;">ğŸ§¾</span>
    <span style="left:30px; bottom:38px;">ğŸ¦</span>
    <span style="right:34px; bottom:22px;">ğŸ’³</span>
    <span style="left:50%; top:12px; transform:translateX(-50%); opacity:.75;">âœ¨</span>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="topbar">
        <h1>å°å¦– Â· æ‹›è´¢åˆ†è´¦å°ç«™</h1>
        <div class="mini">å…å®‰è£…ï½œè‡ªåŠ¨ä¿å­˜ï½œå¯å¯¼å‡ºExcel</div>
      </div>
      <div class="meta">
        <div class="pill">
          <span>ğŸ“… ç»“ç®—æ—¥æœŸ</span>
          <input id="settleDate" type="date" style="width:auto; min-width: 155px;" />
        </div>
        <div class="pill">
          <span>âœ… å·²è½¬è¿›åº¦</span>
          <span id="progressText">0/0</span>
        </div>
        <div class="pill">
          <span>ğŸ’¾ æ•°æ®</span>
          <span class="mini">è‡ªåŠ¨ä¿å­˜</span>
        </div>
      </div>
    </div>

    <div class="nav">
      <button class="btn-ghost active" data-tab="current">æœ¬æ¬¡ç»“ç®—</button>
      <button class="btn-ghost" data-tab="history">å†å²æ•°æ®</button>
      <button class="btn-ghost" data-tab="banks">é“¶è¡Œå¡</button>
      <button class="btn-ghost" data-tab="rules">è§„åˆ™ä¸­å¿ƒ</button>

      <div style="flex:1"></div>

      <label class="badge" style="cursor:pointer;">
        â¬† ä¸Šä¼ Excelæ¨¡æ¿
        <input id="templateInput" type="file" accept=".xlsx" style="display:none;">
      </label>

      <button id="exportBtn" class="btn-warn">â¬‡ å¯¼å‡ºExcel</button>
      <button id="saveSnapBtn" class="btn-ok">ğŸ—‚ ä¿å­˜åˆ°å†å²</button>
      <button id="resetBtn" class="btn-ghost" title="æ¸…ç©ºæœ¬æ¬¡ç»“ç®—ï¼ˆä¸åˆ å†å²ï¼‰">ğŸ§¹ æ¸…ç©ºæœ¬æ¬¡</button>
      <button id="cloudBtn" class="btn-ghost" title="è·¨è®¾å¤‡åŒæ­¥ï¼ˆäº‘ç«¯ï¼‰">â˜ äº‘åŒæ­¥</button>
      <span id="cloudStatus" class="mini" style="opacity:.85;">æœªå¯ç”¨</span>
</div>

    <!-- é¡µé¢å®¹å™¨ -->
    <div id="page"></div>

    <div class="footer">åˆ†è´¦æ¸…æ™°ï½œå¯å‹¾é€‰è¿½è¸ªï½œæ¯”ä¾‹éšæ—¶å¯æ”¹</div>
  </div>

  <!-- æ¯”ä¾‹ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="ratioModalMask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="ratioModalTitle">ç¼–è¾‘æ¯”ä¾‹</div>
          <div class="mini" id="ratioModalSub">ï¼ˆ0~1ï¼Œå°æ•°ä¹Ÿè¡Œï¼›æ€»å’Œå¯ä»¥â‰ 1ï¼Œå‰©ä¸‹çš„é’±å°±ç•™åœ¨åŸå¡ï¼‰</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="ratioModalClose" class="btn-ghost">å…³é—­</button>
          <button id="ratioModalSave" class="btn-primary">ä¿å­˜</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="ratioGrid" class="ratio-grid"></div>
        <div class="ratio-sum">
          <div>
            <div class="mini">å½“å‰æ¯”ä¾‹æ€»å’Œ</div>
            <b id="ratioSumText">0.000</b>
          </div>
          <div class="mini" id="ratioSumHint">æç¤ºï¼šæ€»å’Œâ‰ 1ä¹Ÿæ²¡é—®é¢˜</div>
        </div>
      </div>
    </div>
  </div>

    <!-- å›¾è¡¨æ”¾å¤§æ¨¡æ€æ¡† -->
  <div id="chartModalMask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal" style="width:min(980px,100%);">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="chartModalTitle">å›¾è¡¨æ”¾å¤§</div>
          <div class="mini">æç¤ºï¼šå³é”®/é•¿æŒ‰å¯å¦å­˜å›¾ç‰‡ï¼›ä¹Ÿå¯ä»¥æˆªå›¾å‘ç»™æˆ‘ä¸€èµ·ä¼˜åŒ–ã€‚</div>
        </div>
        <button id="chartModalClose" class="btn-ghost">å…³é—­</button>
      </div>
      <div class="modal-body">
        <div class="zoom-img-wrap">
          <img id="chartZoomImg" class="zoom-img" alt="chart" />
        </div>
      </div>
    </div>
  </div>

  <!-- äº‘åŒæ­¥å†²çªå¤„ç†æ¨¡æ€æ¡† -->
  <div id="conflictModalMask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal" style="width:min(980px,100%);">
      <div class="modal-head">
        <div>
          <div class="modal-title">âš”ï¸ å¤šè®¾å¤‡å†²çª</div>
          <div class="mini">æ£€æµ‹åˆ°äº‘ç«¯ä¸æœ¬åœ°éƒ½åœ¨æ›´æ–°ã€‚æŒ‰æ›´æ–°æ—¶é—´æ’åºå±•ç¤ºï¼Œè¯·ä½ æ‰‹åŠ¨é€‰æ‹©è¦ä¿ç•™å“ªä¸€ä¸ªç‰ˆæœ¬ã€‚</div>
        </div>
        <button id="conflictModalClose" class="btn-ghost">å…ˆä¸å¤„ç†</button>
      </div>
      <div class="modal-body">
        <div id="conflictList" class="list"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
          <button id="conflictUseSelected" class="btn-primary">ä½¿ç”¨é€‰ä¸­çš„ç‰ˆæœ¬</button>
        </div>
        <div class="mini" style="margin-top:10px; opacity:.85; line-height:1.6;">
          å»ºè®®ï¼šå¦‚æœä½ æ­£åœ¨å¦ä¸€å°è®¾å¤‡åˆšå¡«å®Œå¹¶ä¿å­˜åˆ°å†å²ï¼Œå°±é€‰â€œäº‘ç«¯ç‰ˆæœ¬â€ï¼›å¦‚æœä½ è¿™å°åˆšæ”¹å®Œè¿˜æ²¡ä¿å­˜ï¼Œå°±é€‰â€œæœ¬åœ°ç‰ˆæœ¬â€ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- äº‘åŒæ­¥è®¾ç½®æ¨¡æ€æ¡† -->
  <div id="cloudModalMask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal" style="width:min(980px,100%);">
      <div class="modal-head">
        <div>
          <div class="modal-title">â˜ äº‘åŒæ­¥è®¾ç½®ï¼ˆè·¨è®¾å¤‡ï¼‰</div>
          <div class="mini">è‡ªåŠ¨ï¼šæ‰“å¼€ç½‘é¡µå…ˆæ‹‰å–äº‘ç«¯æœ€æ–°ï¼›ä½ ç‚¹ã€ä¿å­˜åˆ°å†å²ã€‘ä¼šè‡ªåŠ¨ä¸Šä¼ è¦†ç›–ï¼ˆæŒ‰æ—¶é—´ä¸ºå‡†ï¼Œä¸åšå†²çªåˆå¹¶ï¼‰ã€‚</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="cloudModalClose" class="btn-ghost">å…³é—­</button>
          <button id="cloudModalSave" class="btn-primary">ä¿å­˜å¹¶ç«‹å³åŒæ­¥</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="item" style="border:1px solid rgba(245,158,11,.25);">
          <div style="font-weight:900;">ğŸ” å®‰å…¨æé†’ï¼ˆå¾ˆé‡è¦ï¼‰</div>
          <div class="mini" style="margin-top:6px; line-height:1.6;">
            Token ç›¸å½“äºä½ çš„â€œä»“åº“é’¥åŒ™â€ã€‚å»ºè®®ç”¨ Fine-grained tokenã€åªæˆæƒè¿™ä¸ªä»“åº“ï¼ˆContents: Read/Writeï¼‰ã€‚
            ä¸è¦æŠŠ token å†™è¿›ä»£ç æˆ–å…¬å¼€å‘ç»™åˆ«äººã€‚
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="grid-column: span 12;">
            <label class="checkline" style="justify-content:flex-start;">
              <input id="cloudEnabled" type="checkbox" style="width:20px;height:20px;" />
              <div>
                <b>å¯ç”¨äº‘åŒæ­¥</b>
                <div class="mini">å¯ç”¨åï¼šæ‰“å¼€ç½‘é¡µè‡ªåŠ¨æ‹‰æœ€æ–°ï¼›ä¿å­˜åˆ°å†å²è‡ªåŠ¨ä¸Šä¼ </div>
              </div>
            </label>
          </div>

          <div style="grid-column: span 4;">
            <div class="mini">GitHub ç”¨æˆ·åï¼ˆownerï¼‰</div>
            <input id="cloudOwner" type="text" placeholder="ä¾‹å¦‚ï¼šwuxyfree-dev" />
          </div>
          <div style="grid-column: span 4;">
            <div class="mini">ä»“åº“åï¼ˆrepoï¼‰</div>
            <input id="cloudRepo" type="text" placeholder="ä¾‹å¦‚ï¼šmoney" />
          </div>
          <div style="grid-column: span 4;">
            <div class="mini">åˆ†æ”¯ï¼ˆbranchï¼‰</div>
            <input id="cloudBranch" type="text" placeholder="main" />
          </div>

          <div style="grid-column: span 6;">
            <div class="mini">åŒæ­¥æ–‡ä»¶è·¯å¾„ï¼ˆpathï¼‰</div>
            <input id="cloudPath" type="text" placeholder="data.json" />
          </div>
          <div style="grid-column: span 6;">
            <div class="mini">Tokenï¼ˆPATï¼‰</div>
            <input id="cloudToken" type="password" placeholder="ä»¥ github_pat_ å¼€å¤´çš„é‚£ä¸²" />
          </div>

          <div style="grid-column: span 12; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button id="cloudTestBtn" class="btn-ghost">æµ‹è¯•è¿æ¥</button>
            <button id="cloudPullBtn" class="btn-ghost">ä»äº‘ç«¯æ‹‰å–</button>
            <button id="cloudPushBtn" class="btn-ghost">ä¸Šä¼ åˆ°äº‘ç«¯</button>
            <span id="cloudModalStatus" class="mini" style="opacity:.85;">æœªæµ‹è¯•</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // ---------------------
  // å¸¸é‡ / åˆå§‹åŒ–
  // ---------------------
  const LS_KEY = "xiaoyao_money_singlefile_v4"; // bump ä¸€ä¸‹ç‰ˆæœ¬ï¼Œé¿å…æ—§ç¼“å­˜åæ•°æ®

  // âœ… å®æ—¶åŒæ­¥å‚æ•°ï¼ˆä½èµ„æºç‰ˆï¼‰
  const SYNC_PULL_INTERVAL_MS = 15000;  // 15s æ‹‰ä¸€æ¬¡ï¼ˆç”¨ ETagï¼Œæ²¡å˜åŒ–åŸºæœ¬æ˜¯ 304ï¼Œä¸è´¹é…é¢/å¸¦å®½ï¼‰
  const SYNC_PUSH_DEBOUNCE_MS = 2500;   // æœ¬åœ°åœæ­¢æ“ä½œ 2.5s åè‡ªåŠ¨æ¨
  const SYNC_PUSH_MIN_GAP_MS = 6000;    // ä¸¤æ¬¡ push æœ€çŸ­é—´éš”ï¼Œé˜²æ­¢è¿ç»­åˆ·

  const CATEGORY = {
    FIXED: "å·¥èµ„æ”¶å…¥",
    BIZ: "ä¸šåŠ¡æ”¶å…¥",
    OTHER: "å…¶ä»–æ”¶å…¥",
  };

  // åŸºç¡€åˆ†é…é¡¹ï¼ˆä½ ç°åœ¨å¸¸ç”¨çš„ï¼‰
  const BASE_BUCKETS = [
    { key: "NECESSARY", name: "ç”Ÿæ´»å¿…è¦æ”¯å‡º", emoji:"ğŸ§¾" },
    { key: "SAVING", name: "å‚¨è“„", emoji:"ğŸ¦" },
    { key: "LOVE", name: "æ‹çˆ±ç»è´¹", emoji:"ğŸ’" },
    { key: "CAR", name: "å…»è½¦ç”¨è½¦", emoji:"â›½" },
    { key: "FLEX", name: "æœºåŠ¨èµ„é‡‘", emoji:"ğŸ’°" },
    { key: "DAD", name: "çˆ¶æ¯-çˆ¶", emoji:"ğŸ‘¨â€ğŸ¦³" },
    { key: "MOM", name: "çˆ¶æ¯-æ¯", emoji:"ğŸ‘©â€ğŸ¦³" },
    { key: "INSTALL", name: "åˆ†æœŸè¿˜æ¬¾", emoji:"ğŸ’³" },
  ];

  const uid = () => (Math.random().toString(16).slice(2) + Date.now().toString(16));
  const trunc2 = (n) => Math.trunc((Number(n)||0) * 100) / 100;
  const parseMoney = (v) => {
    const s = String(v ?? "").replace(/,/g, "").trim();
    if(s === "") return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = (n) => (Number(n)||0).toLocaleString("zh-CN",{minimumFractionDigits:2, maximumFractionDigits:2});

  const todayStr = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  // åŠ¨æ€ bucketsï¼ˆåŸºç¡€ + è‡ªå®šä¹‰ï¼‰
  const allBuckets = (state) => {
    const custom = (state.customBuckets||[]).map(b => ({...b, isCustom:true}));
    return [...BASE_BUCKETS, ...custom];
  };

  // âœ… è®¾å¤‡æ ‡è¯†ï¼šç”¨äºå†²çªæç¤ºï¼ˆä¸ä¼šå‡ºç°åœ¨é¡µé¢ï¼‰
  const DEVICE_ID_KEY = "xiaoyao_money_device_id_v1";
  const deviceId = (() => {
    const old = localStorage.getItem(DEVICE_ID_KEY);
    if(old) return old;
    const id = `dev_${uid()}`;
    localStorage.setItem(DEVICE_ID_KEY, id);
    return id;
  })();

  // ---------------------
  // State
  // ---------------------
  const defaultState = () => ({
    settleDate: todayStr(),
    globalNote: "",

    // Excelæ¨¡æ¿ï¼ˆbase64ï¼‰
    templateB64: null,

    // è‡ªå®šä¹‰åˆ†é…é¡¹ï¼ˆå¯éšæ—¶åŠ ï¼‰
    customBuckets: [],

    banks: [
      { id:"boc_vol", name:"ä¸­è¡Œå¿—æ„¿è€…å¡", last4:"9409" },
      { id:"ccb", name:"å»ºè¡Œ", last4:"0130" },
      { id:"abc_benefit", name:"å†œä¸š/ä¼˜å¾…è¯", last4:"5279" },
      { id:"citic", name:"ä¸­ä¿¡", last4:"9674" },
      { id:"ceb", name:"å…‰å¤§", last4:"9544" },
      { id:"cib", name:"å…´ä¸š", last4:"5617" },
      { id:"alipay_kid", name:"æ”¯ä»˜å®è´¦æˆ·", last4:"å°å­©" },
      { id:"boc_student", name:"ä¸­è¡Œå­¦ç”Ÿå¡", last4:"7937" },
      { id:"boc_soldier", name:"ä¸­è¡Œå†›äººå¡", last4:"2239" },
      { id:"psbc", name:"é‚®å‚¨", last4:"8387" },
      { id:"cmb", name:"æ‹›è¡Œ", last4:"8327" },
    ],

    // æ¯ä¸ªåˆ†é…é¡¹å¯¹åº”çš„é“¶è¡Œå¡
    bucketBank: {
      NECESSARY: "boc_vol",
      SAVING: "psbc",
      LOVE: "cib",
      CAR: "citic",
      FLEX: "abc_benefit",
      DAD: "abc_benefit",
      MOM: "abc_benefit",
      INSTALL: "abc_benefit",
    },

    schemes: [
      {
        id: "fixed_default", category:"FIXED", name:"å·¥èµ„é»˜è®¤",
        ratios: { NECESSARY:.4, SAVING:.2, LOVE:.1, CAR:.04, FLEX:.1, DAD:.025, MOM:.075, INSTALL:.06 }
      },
      {
        id: "biz_default", category:"BIZ", name:"ä¸šåŠ¡é»˜è®¤",
        ratios: { NECESSARY:.2, SAVING:.2, LOVE:.05, CAR:.15, FLEX:.1, DAD:.1, MOM:.2 }
      },
      {
        id: "other_default", category:"OTHER", name:"å…¶ä»–é»˜è®¤",
        ratios: { NECESSARY:.2, SAVING:.3, LOVE:.1, FLEX:.4 }
      },
    ],

    incomeItems: [
      { id:uid(), name:"å·¥èµ„/æ´¥è´´", amount:0, category:"FIXED", schemeId:"fixed_default", include:true, note:"" },
    ],

    reimburse: [
      { id:uid(), date: todayStr(), amount:0, purpose:"å«ä»˜æŠ¥è´¦", payer:"", expected:"", status:"æœªæŠ¥", note:"" },
    ],

    transferChecks: {},
    history: [],

    // âœ… åŒæ­¥å…ƒæ•°æ®ï¼ˆæœ¬åœ°ï¼‰
    lastLocalUpdateAt: Date.now(),
    cloudUpdatedAt: 0,
  });

  let S = load() || defaultState();

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  // âœ… è½»é‡ hashï¼ˆåˆ¤æ–­æ˜¯å¦æœ‰æ”¹åŠ¨ï¼Œé¿å…é¢‘ç¹ pushï¼‰
  function fastHash(str){
    let h = 5381;
    for(let i=0;i<str.length;i++) h = ((h<<5) + h) ^ str.charCodeAt(i);
    return (h >>> 0).toString(16);
  }

  function stripTransientState(state){
    const copy = JSON.parse(JSON.stringify(state));
    delete copy.templateB64;
    (copy.incomeItems||[]).forEach(it => { delete it._raw; });
    (copy.reimburse||[]).forEach(r => { delete r._raw; });
    return copy;
  }

  function snapshotForHash(){
    return JSON.stringify(stripTransientState(S));
  }

  // âœ… æœ¬åœ°å˜æ›´è·Ÿè¸ª
  let localDirty = false;
  let lastSavedHash = fastHash(snapshotForHash());
  let pushTimer = null;
  let lastPushAt = 0;

  function markDirty(reason=""){
    localDirty = true;
    S.lastLocalUpdateAt = Date.now();
    save();
    scheduleAutoPush(reason);
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  function ensureConsistency(){
    S.customBuckets = S.customBuckets || [];
    S.bucketBank = S.bucketBank || {};
    const buckets = allBuckets(S);
    const fallbackBank = (S.banks && S.banks[0] && S.banks[0].id) ? S.banks[0].id : null;
    buckets.forEach(b => {
      if(!S.bucketBank[b.key] && fallbackBank){
        S.bucketBank[b.key] = fallbackBank;
      }
    });
    (S.schemes||[]).forEach(s => { s.ratios = s.ratios || {}; });
    (S.schemes||[]).forEach(s => {
      buckets.forEach(b => {
        if(s.ratios[b.key] == null) s.ratios[b.key] = Number(s.ratios[b.key]||0);
      });
    });
    (S.incomeItems||[]).forEach(it => {
      if(typeof it.amount !== "number") it.amount = Number(it.amount||0);
      if(!it.category) it.category = "FIXED";
      if(!it.schemeId){
        const def = (S.schemes||[]).find(x => x.category===it.category);
        it.schemeId = def ? def.id : (S.schemes[0]?.id || "fixed_default");
      }
      if(it.include == null) it.include = true;
    });
    save();
  }

  ensureConsistency();

  // ---------------------
  // DOM
  // ---------------------
  const page = document.getElementById("page");
  const settleDateEl = document.getElementById("settleDate");
  const exportBtn = document.getElementById("exportBtn");
  const saveSnapBtn = document.getElementById("saveSnapBtn");
  const resetBtn = document.getElementById("resetBtn");
  const progressText = document.getElementById("progressText");
  const templateInput = document.getElementById("templateInput");

  // ratio modal
  const ratioModalMask = document.getElementById("ratioModalMask");
  const ratioModalTitle = document.getElementById("ratioModalTitle");
  const ratioGrid = document.getElementById("ratioGrid");
  const ratioSumText = document.getElementById("ratioSumText");
  const ratioModalClose = document.getElementById("ratioModalClose");
  const ratioModalSave = document.getElementById("ratioModalSave");

  // chart modal
  const chartModalMask = document.getElementById("chartModalMask");
  const chartModalTitle = document.getElementById("chartModalTitle");
  const chartZoomImg = document.getElementById("chartZoomImg");
  const chartModalClose = document.getElementById("chartModalClose");

  // conflict modal
  const conflictModalMask = document.getElementById("conflictModalMask");
  const conflictModalClose = document.getElementById("conflictModalClose");
  const conflictList = document.getElementById("conflictList");
  const conflictUseSelected = document.getElementById("conflictUseSelected");

  let pieChart = null;
  let barChart = null;

  let tab = "current";

  settleDateEl.value = S.settleDate;
  settleDateEl.addEventListener("change", (e) => {
    S.settleDate = e.target.value || todayStr();
    S.reimburse = (S.reimburse||[]).map(r => ({...r, date: r.date || S.settleDate}));
    markDirty("æ”¹ç»“ç®—æ—¥æœŸ");
    render();
  });

  document.querySelectorAll('.nav button[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      tab = btn.dataset.tab;
      document.querySelectorAll('.nav button[data-tab]').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      render();
    });
  });

  // ä¸Šä¼ æ¨¡æ¿
  templateInput.addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const buf = await f.arrayBuffer();
    S.templateB64 = arrayBufferToB64(buf);
    // æ¨¡æ¿ä¸åšäº‘åŒæ­¥ï¼Œä½†å±äºæœ¬åœ°èµ„äº§
    save();
    alert(`æ¨¡æ¿å·²ä¿å­˜âœ…

å¯¼å‡ºæ—¶ä¼šï¼š
1ï¼‰ä¼˜å…ˆå†™å…¥/æ›´æ–°æ¨¡æ¿é‡Œçš„ DATA / è½¬è´¦æ¸…å• / å«ä»˜æŠ¥è´¦ / é“¶è¡Œå¡ï¼ˆä¿ç•™å·²æœ‰æ ·å¼å°½é‡ä¸åŠ¨ï¼‰
2ï¼‰è‹¥æ¨¡æ¿æ²¡æœ‰è¿™äº›sheetï¼Œä¼šè‡ªåŠ¨æ–°å»ºï¼ˆæ¨¡æ¿å¯ç”¨å…¬å¼å¼•ç”¨å®ƒä»¬ï¼‰`);
    e.target.value = "";
  });

  exportBtn.addEventListener("click", () => exportExcel());

  saveSnapBtn.addEventListener("click", async () => {
    const snap = {
      id: `${S.settleDate}_${uid()}`,
      createdAt: Date.now(),
      settleDate: S.settleDate,
      globalNote: S.globalNote,
      banks: S.banks,
      bucketBank: S.bucketBank,
      schemes: S.schemes,
      incomeItems: S.incomeItems,
      reimburse: S.reimburse,
      transferChecks: S.transferChecks,
      templateB64: S.templateB64,
      customBuckets: S.customBuckets,
      _deviceId: deviceId,
    };
    S.history = [snap, ...(S.history||[])];

    markDirty("ä¿å­˜åˆ°å†å²");

    tab = "history";
    document.querySelectorAll('.nav button[data-tab]').forEach(x => x.classList.remove('active'));
    document.querySelector('.nav button[data-tab="history"]').classList.add('active');
    render();
  });

  resetBtn.addEventListener("click", () => {
    if(!confirm("ç¡®è®¤æ¸…ç©ºã€æœ¬æ¬¡ç»“ç®—ã€‘ï¼Ÿï¼ˆä¸ä¼šåˆ é™¤å†å²ï¼‰")) return;
    const keep = {
      history: S.history,
      banks: S.banks,
      bucketBank: S.bucketBank,
      schemes: S.schemes,
      templateB64: S.templateB64,
      customBuckets: S.customBuckets,
      cloudUpdatedAt: S.cloudUpdatedAt,
    };
    S = { ...defaultState(), ...keep, settleDate: S.settleDate };
    ensureConsistency();
    markDirty("æ¸…ç©ºæœ¬æ¬¡");
    render();
  });

  // chart modal handlers
  chartModalClose.addEventListener('click', () => closeChartModal());
  chartModalMask.addEventListener('click', (e) => { if(e.target === chartModalMask) closeChartModal(); });
  function openChartModal(title, canvasId){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    chartModalTitle.textContent = title;
    chartZoomImg.src = canvas.toDataURL('image/png');
    chartModalMask.style.display = 'flex';
  }
  function closeChartModal(){
    chartModalMask.style.display = 'none';
    chartZoomImg.src = '';
  }

  // conflict modal handlers
  conflictModalClose.addEventListener('click', () => closeConflictModal());
  conflictModalMask.addEventListener('click', (e)=>{ if(e.target===conflictModalMask) closeConflictModal(); });

  // ---------------------
  // è®¡ç®—ï¼šåˆ†æ¡¶ + è½¬è´¦æ¸…å•
  // ---------------------
  function schemeById(){
    const map = {};
    (S.schemes||[]).forEach(x => map[x.id] = x);
    return map;
  }

  function totalsByCategory(){
    const t = { FIXED:0, BIZ:0, OTHER:0 };
    (S.incomeItems||[]).forEach(it => {
      if(!it.include) return;
      t[it.category] += (Number(it.amount)||0);
    });
    return t;
  }

  function emptyBucketMap(){
    const buckets = allBuckets(S);
    return Object.fromEntries(buckets.map(b => [b.key, 0]));
  }

  function allocatedByCategory(){
    const buckets = allBuckets(S);
    const out = { FIXED: emptyBucketMap(), BIZ: emptyBucketMap(), OTHER: emptyBucketMap() };
    const map = schemeById();

    (S.incomeItems||[]).forEach(it => {
      if(!it.include) return;
      const base = Number(it.amount)||0;
      const sch = map[it.schemeId];
      const ratios = (sch && sch.ratios) ? sch.ratios : {};
      buckets.forEach(b => {
        const r = Number(ratios[b.key]||0);
        out[it.category][b.key] = trunc2(out[it.category][b.key] + trunc2(base * r));
      });
    });
    return out;
  }

  function allocatedTotal(){
    const buckets = allBuckets(S);
    const byCat = allocatedByCategory();
    const out = Object.fromEntries(buckets.map(b => [b.key, 0]));
    Object.keys(CATEGORY).forEach(cat => {
      buckets.forEach(b => out[b.key] = trunc2(out[b.key] + (byCat[cat][b.key]||0)));
    });
    return out;
  }

  function transferLines(){
    const buckets = allBuckets(S);
    const byCat = allocatedByCategory();
    const lines = [];
    Object.keys(CATEGORY).forEach(cat => {
      buckets.forEach(b => {
        const amt = Number(byCat[cat][b.key]||0);
        if(amt<=0) return;
        const bankId = S.bucketBank[b.key];
        const key = `${S.settleDate}|${cat}|${bankId}|${b.key}`;
        lines.push({ category:cat, bankId, bucket:b.key, bucketName:`${b.emoji} ${b.name}`, amount:amt, checkKey:key });
      });
    });
    return lines;
  }

  function progress(){
    const lines = transferLines();
    const total = lines.length;
    const checked = lines.filter(x => !!S.transferChecks[x.checkKey]).length;
    return { total, checked };
  }

  function bankByIdMap(){
    const m = {};
    (S.banks||[]).forEach(b => m[b.id] = b);
    return m;
  }

  // ---------------------
  // é˜²æ­¢â€œè¾“å…¥ä¸€ä½å°±è¢«æ‰“æ–­â€ï¼šä¿ç•™ç„¦ç‚¹ + å…‰æ ‡
  // ---------------------
  let renderTimer = null;
  function scheduleRender(preserve=true){
    if(renderTimer) clearTimeout(renderTimer);
    const active = preserve ? captureActiveElement() : null;
    renderTimer = setTimeout(() => {
      renderTimer = null;
      render();
      if(active) restoreActiveElement(active);
    }, 60);
  }

  function captureActiveElement(){
    const el = document.activeElement;
    if(!el) return null;
    const marker = el.getAttribute && el.getAttribute('data-focus');
    if(!marker) return null;
    const start = (typeof el.selectionStart === 'number') ? el.selectionStart : null;
    const end = (typeof el.selectionEnd === 'number') ? el.selectionEnd : null;
    return { marker, start, end };
  }

  function restoreActiveElement(info){
    try{
      const marker = cssEscape(info.marker);
      const el = document.querySelector(`[data-focus="${marker}"]`);
      if(!el) return;
      el.focus();
      if(info.start!=null && info.end!=null && typeof el.setSelectionRange==='function'){
        el.setSelectionRange(info.start, info.end);
      }
    }catch{ /* ignore */ }
  }

  function cssEscape(s){
    if(window.CSS && typeof window.CSS.escape === 'function') return window.CSS.escape(String(s));
    return String(s).replace(/[^a-zA-Z0-9_\-]/g, "\$&");
  }

  // ---------------------
  // æ¸²æŸ“
  // ---------------------
  function render(){
    save();
    const p = progress();
    progressText.textContent = `${p.checked}/${p.total}`;

    if(tab === "current") renderCurrent();
    else if(tab === "history") renderHistory();
    else if(tab === "banks") renderBanks();
    else renderRules();
  }

  function renderCurrent(){
    ensureConsistency();

    const t = totalsByCategory();
    const total = t.FIXED + t.BIZ + t.OTHER;
    const allocT = allocatedTotal();
    const lines = transferLines();
    const bankMap = bankByIdMap();
    const buckets = allBuckets(S);

    // ç±»åˆ« -> é“¶è¡Œå¡ -> lines
    const grouped = { FIXED:{}, BIZ:{}, OTHER:{} };
    lines.forEach(ln => {
      grouped[ln.category][ln.bankId] = grouped[ln.category][ln.bankId] || [];
      grouped[ln.category][ln.bankId].push(ln);
    });

    // æ”¶å…¥æ„æˆç™¾åˆ†æ¯”ï¼ˆä¸¥æ ¼åˆè®¡=100ï¼‰
    let pct = { FIXED:0, BIZ:0, OTHER:0 };
    if(total > 0){
      pct = {
        FIXED: Number((t.FIXED/total*100).toFixed(2)),
        BIZ: Number((t.BIZ/total*100).toFixed(2)),
        OTHER: Number((t.OTHER/total*100).toFixed(2)),
      };
      const sumPct = pct.FIXED + pct.BIZ + pct.OTHER;
      if(Math.abs(sumPct-100) > 0.001){
        const arr = [
          {k:'FIXED',v:pct.FIXED},
          {k:'BIZ',v:pct.BIZ},
          {k:'OTHER',v:pct.OTHER},
        ].sort((a,b)=>b.v-a.v);
        const diff = Number((100 - sumPct).toFixed(2));
        pct[arr[0].k] = Number((pct[arr[0].k] + diff).toFixed(2));
      }
    }

    page.innerHTML = `
      <div class="col">
        <div class="card">
          <h2>æ”¶å…¥å½•å…¥</h2>

          <div class="row">
            <div style="grid-column: span 12;">
              <div class="mini">æœ¬æ¬¡å¤‡æ³¨</div>
              <textarea id="globalNote" placeholder="å¯é€‰ï¼šæ¯”å¦‚å¹´ç»ˆå¥–åŒ…å«ä»€ä¹ˆâ€¦">${escapeHtml(S.globalNote||"")}</textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div style="grid-column: span 8; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <div class="tag">ğŸ“Œ æ”¶å…¥æ˜ç»†</div>
              <div class="mini">ï¼ˆå‹¾é€‰=è®¡å…¥åˆ†è´¦ï¼‰</div>
            </div>
            <div style="grid-column: span 4; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
              <button class="btn-ghost" id="addFixed">+ å·¥èµ„</button>
              <button class="btn-ghost" id="addBiz">+ ä¸šåŠ¡</button>
              <button class="btn-primary" id="addIncome">+ æ–°å¢</button>
            </div>
          </div>

          <div class="list" id="incomeList"></div>

          <div class="kpi">
            <div class="box"><div class="t">å·¥èµ„åˆè®¡</div><div class="v">Â¥ ${fmt(t.FIXED)}</div></div>
            <div class="box"><div class="t">ä¸šåŠ¡åˆè®¡</div><div class="v">Â¥ ${fmt(t.BIZ)}</div></div>
            <div class="box"><div class="t">å…¶ä»–åˆè®¡</div><div class="v">Â¥ ${fmt(t.OTHER)}</div></div>
            <div class="box"><div class="t">æ€»æ”¶å…¥ï¼ˆè®¡å…¥é¡¹ï¼‰</div><div class="v">Â¥ ${fmt(total)}</div></div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <h2 style="margin:0;">ğŸ§® åˆ†é…æ€»è§ˆ</h2>
            <button class="btn-ghost" id="addBucket">â• æ–°å¢åˆ†é…é¡¹</button>
          </div>

          <div class="list" style="margin-top:10px;">
            ${buckets.map(b => {
              const isCustom = !!b.isCustom;
              return `
                <div class="checkline">
                  <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                    <div style="white-space:nowrap;">${b.emoji}</div>
                    <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 420px; font-weight:900;">${escapeHtml(b.name)}</div>
                    ${isCustom ? `<span class="mini">è‡ªå®šä¹‰</span>` : ``}
                  </div>
                  <div style="display:flex; align-items:center; gap:10px;">
                    <div style="font-weight:900; font-size:18px;">Â¥ ${fmt(allocT[b.key]||0)}</div>
                    ${isCustom ? `<button class="btn-ghost" data-act="delBucket" data-bucket="${b.key}" style="padding:8px 10px;">åˆ é™¤</button>` : ``}
                  </div>
                </div>
              `;
            }).join("")}
          </div>

          <div class="item" style="margin-top:10px;">
            <div class="stackhead">
              <div style="font-weight:900;">æ”¶å…¥æ„æˆæ¯”ä¾‹</div>
              <div class="mini">æ€»æ”¶å…¥ï¼šÂ¥ ${fmt(total)}</div>
            </div>
            <div class="stacklegend" style="margin-top:8px;">
              <span class="badge"><span class="dot dot-fixed"></span>å·¥èµ„ï¼š${pct.FIXED}%</span>
              <span class="badge"><span class="dot dot-biz"></span>ä¸šåŠ¡ï¼š${pct.BIZ}%</span>
              <span class="badge"><span class="dot dot-other"></span>å…¶ä»–ï¼š${pct.OTHER}%</span>
            </div>
            <div class="stackwrap">
              <div class="stackbar" aria-label="æ”¶å…¥æ„æˆæ¯”ä¾‹æ¡">
                <div class="seg-fixed" style="width:${Math.max(0,pct.FIXED)}%;" title="å·¥èµ„æ”¶å…¥ Â¥ ${fmt(t.FIXED)}ï¼ˆ${pct.FIXED}%ï¼‰">
                  <span>å·¥èµ„ Â¥ ${fmt(t.FIXED)}</span>
                </div>
                <div class="seg-biz" style="width:${Math.max(0,pct.BIZ)}%;" title="ä¸šåŠ¡æ”¶å…¥ Â¥ ${fmt(t.BIZ)}ï¼ˆ${pct.BIZ}%ï¼‰">
                  <span>ä¸šåŠ¡ Â¥ ${fmt(t.BIZ)}</span>
                </div>
                <div class="seg-other" style="width:${Math.max(0,pct.OTHER)}%;" title="å…¶ä»–æ”¶å…¥ Â¥ ${fmt(t.OTHER)}ï¼ˆ${pct.OTHER}%ï¼‰">
                  <span>å…¶ä»– Â¥ ${fmt(t.OTHER)}</span>
                </div>
              </div>
            </div>
            <div class="mini" style="margin-top:8px;">è¯´æ˜ï¼šæ¯”ä¾‹æ¡å®½åº¦ä¸¥æ ¼æŒ‰ç™¾åˆ†æ¯”ï¼ˆè‡ªåŠ¨ä¿®æ­£åˆ° 100%ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="split">
          <div class="card">
            <h2>ğŸ¦ ç”¨é€” â†’ é“¶è¡Œå¡</h2>
            <div class="mini">ï¼ˆå›ºå®šï¼šç”¨é€”å¯¹åº”å“ªå¼ å¡ï¼›å¯éšæ—¶æ”¹ï¼‰</div>
            <div class="list" style="margin-top:10px;" id="bucketBankList"></div>
          </div>
          <div class="card">
            <h2>âœ… æŒ‰ç±»åˆ«è½¬è´¦</h2>
            <div class="mini">ï¼ˆæŒ‰ç±»åˆ«Ã—é“¶è¡Œå¡åˆ†ç»„ï¼Œç…§ç€è½¬å°±è¡Œï¼‰</div>
            <div id="transferArea" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="card">
          <h2>å«ä»˜æŠ¥è´¦</h2>
          <div class="mini">ï¼ˆä¸å‚ä¸åˆ†è´¦ï¼›ç”¨äºè®°å½•å¾…å›æ¬¾ã€å¯¹è´¦ï¼‰</div>

          <div class="row" style="margin-top:8px;">
            <div style="grid-column: span 8;"></div>
            <div style="grid-column: span 4; display:flex; justify-content:flex-end;">
              <button class="btn-ghost" id="addReim">+ æ–°å¢å«ä»˜</button>
            </div>
          </div>

          <div class="list" id="reimList"></div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="section-title">ğŸ“Š å¯è§†åŒ–</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="badge">æç¤ºï¼šç‚¹å›¾å¯æ”¾å¤§</span>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="grid-column: span 12;" class="item" id="barWrap">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                <div style="font-weight:900;">ç±»åˆ«æ”¶å…¥ï¼ˆæŸ±çŠ¶ï¼‰</div>
                <button class="btn-ghost" id="zoomBar" style="padding:8px 10px;">æ”¾å¤§</button>
              </div>
              <canvas id="barCanvas" class="zoomable" style="margin-top:8px;"></canvas>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="grid-column: span 12;" class="item" id="pieWrap">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                <div style="font-weight:900;">åˆ†é…å æ¯”ï¼ˆé¥¼å›¾ï¼‰</div>
                <button class="btn-ghost" id="zoomPie" style="padding:8px 10px;">æ”¾å¤§</button>
              </div>
              <canvas id="pieCanvas" class="zoomable" style="margin-top:8px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:900; font-size:24px;">ğŸ§  æ™ºèƒ½æç¤º & å¾…åŠ</div>
          <div class="mini">ï¼ˆæ›´åƒè´¢å¯Œç®¡å®¶ï¼šä¸€çœ¼çŸ¥é“å“ªé‡Œè¦å¤„ç†ï¼‰</div>
        </div>

        ${(() => {
          const sumAlloc = Object.values(allocT).reduce((a,v)=>a+(Number(v)||0),0);
          const unalloc = trunc2((t.FIXED+t.BIZ+t.OTHER) - sumAlloc);
          const linesAll = transferLines();
          const done = linesAll.filter(x => !!S.transferChecks[x.checkKey]).length;
          const todo = linesAll.length - done;

          const reims = (S.reimburse||[]);
          const reimUn = trunc2(reims.filter(r=>r.status==="æœªæŠ¥").reduce((a,r)=>a+(Number(r.amount)||0),0));
          const reimWait = trunc2(reims.filter(r=>r.status==="å·²æŠ¥å¾…å›").reduce((a,r)=>a+(Number(r.amount)||0),0));

          const schMap = schemeById();
          const warns = [];
          (S.incomeItems||[]).forEach(it => {
            if(!it.include) return;
            const sch = schMap[it.schemeId];
            if(!sch) return;
            const sum = Object.values(sch.ratios||{}).reduce((a,v)=>a+(Number(v)||0),0);
            if(sum > 1.0005) warns.push(`${it.name||'æ”¶å…¥é¡¹'} çš„æ¯”ä¾‹æ€»å’Œ ${sum.toFixed(3)} > 1ï¼ˆä¼šè¶…åˆ†é…ï¼‰`);
          });

          return `
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px;">
              <div class="checkline">
                <div><b>æœªè½¬è´¦å¾…åŠ</b><div class="mini">æŒ‰ç±»åˆ«è½¬è´¦é‡Œå‹¾æ‰å°±æ¸…é›¶</div></div>
                <div><b>${todo}</b> <span class="mini">é¡¹</span></div>
              </div>

              <div class="checkline">
                <div><b>åˆ†é…åˆè®¡</b><div class="mini">å½“å‰æ–¹æ¡ˆè®¡ç®—å‡ºçš„è½¬è´¦æ€»é¢</div></div>
                <div><b>Â¥ ${fmt(sumAlloc)}</b></div>
              </div>

              <div class="checkline">
                <div><b>æœªåˆ†é…ï¼ˆç•™åœ¨åŸå¡ï¼‰</b><div class="mini">æ¯”ä¾‹æ€»å’Œ&lt;1 æ—¶ä¼šå‡ºç°</div></div>
                <div><b>Â¥ ${fmt(unalloc)}</b></div>
              </div>

              <div class="checkline">
                <div><b>å«ä»˜æœªæŠ¥</b><div class="mini">å»ºè®®ä¼˜å…ˆå‚¬æ”¶æˆ–è¡¥æµç¨‹</div></div>
                <div><b>Â¥ ${fmt(reimUn)}</b></div>
              </div>

              <div class="checkline">
                <div><b>å«ä»˜å¾…å›</b><div class="mini">å·²æäº¤ä½†è¿˜æ²¡å›æ¬¾</div></div>
                <div><b>Â¥ ${fmt(reimWait)}</b></div>
              </div>

              ${warns.length ? `
                <div class="item" style="border:1px solid rgba(239,68,68,.35);">
                  <div style="font-weight:900; color: var(--danger);">âš  æ¯”ä¾‹å¼‚å¸¸</div>
                  <div class="mini" style="margin-top:6px; color:#b91c1c;">
                    ${warns.map(w=>`â€¢ ${escapeHtml(w)}`).join('<br/>')}
                  </div>
                </div>
              ` : ``}
            </div>
          `;
        })()}
      </div>
    `;

    // bindï¼šglobal note
    document.getElementById("globalNote").addEventListener("input", (e) => {
      S.globalNote = e.target.value;
      markDirty("ç¼–è¾‘å¤‡æ³¨");
    });

    document.getElementById("addBucket").addEventListener("click", () => addCustomBucket());

    page.querySelectorAll('[data-act="delBucket"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.bucket;
        deleteCustomBucket(key);
      });
    });

    drawIncomeList();
    drawReimList();
    drawBucketBankList();
    drawTransferArea(grouped, bankMap);
    drawCharts(t, allocT);

    document.getElementById("addIncome").onclick = () => addIncome();
    document.getElementById("addFixed").onclick = () => addIncome({category:"FIXED", name:"å·¥èµ„/æ´¥è´´"});
    document.getElementById("addBiz").onclick = () => addIncome({category:"BIZ", name:"ä¸šåŠ¡å›æ¬¾"});
    document.getElementById("addReim").onclick = () => addReim();

    const zoomPieBtn = document.getElementById('zoomPie');
    const zoomBarBtn = document.getElementById('zoomBar');
    const pieCanvas = document.getElementById('pieCanvas');
    const barCanvas = document.getElementById('barCanvas');
    const openPie = () => openChartModal('åˆ†é…å æ¯”ï¼ˆé¥¼å›¾ï¼‰Â· æ”¾å¤§', 'pieCanvas');
    const openBar = () => openChartModal('ç±»åˆ«æ”¶å…¥ï¼ˆæŸ±çŠ¶ï¼‰Â· æ”¾å¤§', 'barCanvas');
    if(zoomPieBtn) zoomPieBtn.addEventListener('click', openPie);
    if(zoomBarBtn) zoomBarBtn.addEventListener('click', openBar);
    if(pieCanvas) pieCanvas.addEventListener('click', openPie);
    if(barCanvas) barCanvas.addEventListener('click', openBar);
  }

  // ---------------------
  // æ”¶å…¥åˆ—è¡¨
  // ---------------------
  function drawIncomeList(){
    const list = document.getElementById("incomeList");
    list.innerHTML = "";

    const schemeOptsByCat = (cat) => (S.schemes||[]).filter(s => s.category===cat);

    (S.incomeItems||[]).forEach((it) => {
      const schemes = schemeOptsByCat(it.category);
      const item = document.createElement("div");
      item.className = "item";

      const focusAmount = `income:${it.id}:amount`;
      const focusName = `income:${it.id}:name`;
      const focusNote = `income:${it.id}:note`;

      item.innerHTML = `
        <div class="income-line">
          <div class="income-field small" style="min-width:120px;">
            <div class="mini">è®¡å…¥</div>
            <div style="display:flex; align-items:center; gap:8px; height: 44px;">
              <input type="checkbox" ${it.include ? "checked":""} data-k="include" style="width:20px;height:20px;" />
              <span class="mini">âœ“</span>
            </div>
          </div>

          <div class="income-field big">
            <div class="mini">åç§°</div>
            <input type="text" value="${escapeAttr(it.name||"")}" data-k="name" data-focus="${escapeAttr(focusName)}" placeholder="æ¯”å¦‚ï¼šå·¥èµ„/å¥–é‡‘/ä¸šåŠ¡å›æ¬¾" />
          </div>

          <div class="income-field">
            <div class="mini">é‡‘é¢</div>
            <input type="text" value="${escapeAttr((it._raw ?? String(Number(it.amount)||0)))}" data-k="amount" data-focus="${escapeAttr(focusAmount)}" inputmode="decimal" placeholder="0.00" />
          </div>

          <div class="income-field">
            <div class="mini">ç±»åˆ«</div>
            <select data-k="category">
              ${Object.keys(CATEGORY).map(k => `<option value="${k}" ${it.category===k?"selected":""}>${CATEGORY[k]}</option>`).join("")}
            </select>
          </div>

          <div class="income-field scheme">
            <div class="mini">æ¯”ä¾‹æ–¹æ¡ˆï¼ˆå¯è‡ªå®šä¹‰ï¼‰</div>
            <div class="scheme-inline">
              <select data-k="schemeId">
                ${schemes.map(s => `<option value="${s.id}" ${it.schemeId===s.id?"selected":""}>${escapeHtml(s.name)}</option>`).join("")}
                <option value="__NEW__">+ æ–°å¢è‡ªå®šä¹‰æ¯”ä¾‹</option>
              </select>
              <button class="btn-ghost" data-k="editScheme">ç¼–è¾‘æ¯”ä¾‹</button>
              <button class="btn-ghost" data-k="remove">åˆ é™¤</button>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="mini">å¤‡æ³¨</div>
          <input type="text" value="${escapeAttr(it.note||"")}" data-k="note" data-focus="${escapeAttr(focusNote)}" placeholder="å¯é€‰" />
        </div>
      `;

      item.querySelector('[data-k="include"]').addEventListener("change", (e)=>{
        it.include = e.target.checked;
        markDirty("åˆ‡æ¢è®¡å…¥");
        scheduleRender(true);
      });

      item.querySelector('[data-k="name"]').addEventListener("input", (e)=>{
        it.name = e.target.value;
        markDirty("æ”¹æ”¶å…¥åç§°");
      });

      {
        const amtEl = item.querySelector('[data-k="amount"]');
        amtEl.addEventListener("input", (e)=>{
          it._raw = e.target.value;
          // è¾“å…¥è¿‡ç¨‹ä¸è§¦å‘æ•´é¡µé‡æ¸²æŸ“ï¼Œä½†ç®—ä½œæœ¬åœ°å˜æ›´ï¼šä¼šåœ¨åœæ­¢è¾“å…¥åè‡ªåŠ¨æ¨
          markDirty("è¾“å…¥é‡‘é¢");
        });
        const commit = () => {
          it.amount = parseMoney(it._raw);
          it._raw = String(it._raw ?? it.amount);
          // æäº¤åå†åˆ·æ–°å›¾è¡¨
          save();
          scheduleRender(false);
        };
        amtEl.addEventListener("change", commit);
        amtEl.addEventListener("blur", commit);
        amtEl.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") { ev.preventDefault(); amtEl.blur(); } });
      }

      item.querySelector('[data-k="note"]').addEventListener("input", (e)=>{
        it.note = e.target.value;
        markDirty("æ”¹æ”¶å…¥å¤‡æ³¨");
      });

      item.querySelector('[data-k="category"]').addEventListener("change", (e)=>{
        it.category = e.target.value;
        const s = (S.schemes||[]).find(x => x.category===it.category);
        if(s) it.schemeId = s.id;
        markDirty("æ”¹æ”¶å…¥ç±»åˆ«");
        scheduleRender(true);
      });

      item.querySelector('[data-k="schemeId"]').addEventListener("change", (e)=>{
        const v = e.target.value;
        if(v === "__NEW__"){
          const newId = createSchemeFromIncomeItem(it);
          it.schemeId = newId;
          markDirty("æ–°å¢è‡ªå®šä¹‰æ¯”ä¾‹");
          scheduleRender(true);
          openRatioModal(it.category, newId);
        }else{
          it.schemeId = v;
          markDirty("åˆ‡æ¢æ¯”ä¾‹æ–¹æ¡ˆ");
          scheduleRender(true);
        }
      });

      item.querySelector('[data-k="editScheme"]').addEventListener("click", ()=>{
        openRatioModal(it.category, it.schemeId);
      });

      item.querySelector('[data-k="remove"]').addEventListener("click", ()=>{
        S.incomeItems = S.incomeItems.filter(x => x.id !== it.id);
        markDirty("åˆ é™¤æ”¶å…¥é¡¹");
        scheduleRender(false);
      });

      list.appendChild(item);
    });
  }

  function addIncome(patch={}){
    const cat = patch.category || "FIXED";
    const defScheme = (S.schemes||[]).find(s => s.category===cat)?.id || "fixed_default";
    S.incomeItems.push({
      id: uid(),
      name: patch.name || "æ–°çš„æ”¶å…¥é¡¹",
      amount: patch.amount || 0,
      category: cat,
      schemeId: patch.schemeId || defScheme,
      include: (patch.include ?? true),
      note: patch.note || ""
    });
    markDirty("æ–°å¢æ”¶å…¥é¡¹");
    scheduleRender(false);
  }

  function createSchemeFromIncomeItem(it){
    const map = schemeById();
    const base = map[it.schemeId];
    const name = prompt("ç»™è¿™ä¸ªè‡ªå®šä¹‰æ¯”ä¾‹èµ·ä¸ªåå­—ï¼š", `${CATEGORY[it.category]}-è‡ªå®šä¹‰`);
    const newScheme = {
      id: uid(),
      category: it.category,
      name: (name && name.trim()) ? name.trim() : `${CATEGORY[it.category]}-è‡ªå®šä¹‰`,
      ratios: JSON.parse(JSON.stringify((base && base.ratios) ? base.ratios : {})),
    };
    allBuckets(S).forEach(b => { if(newScheme.ratios[b.key] == null) newScheme.ratios[b.key] = 0; });
    S.schemes.push(newScheme);
    return newScheme.id;
  }

  // ---------------------
  // æŠ¥è´¦åˆ—è¡¨
  // ---------------------
  function drawReimList(){
    const list = document.getElementById("reimList");
    list.innerHTML = "";

    (S.reimburse||[]).forEach(r => {
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="row">
          <div style="grid-column: span 3;">
            <div class="mini">æ—¥æœŸ</div>
            <input type="date" value="${escapeAttr(r.date||S.settleDate)}" data-k="date" />
          </div>
          <div style="grid-column: span 2;">
            <div class="mini">é‡‘é¢</div>
            <input type="text" value="${escapeAttr((r._raw ?? String(Number(r.amount)||0)))}" data-k="amount" inputmode="decimal" placeholder="0.00" />
          </div>
          <div style="grid-column: span 3;">
            <div class="mini">ç”¨é€”</div>
            <input type="text" value="${escapeAttr(r.purpose||"")}" data-k="purpose" placeholder="æ¯”å¦‚ï¼šä¼šè®®å«ä»˜/é‡‡è´­å«ä»˜" />
          </div>
          <div style="grid-column: span 2;">
            <div class="mini">çŠ¶æ€</div>
            <select data-k="status">
              ${["æœªæŠ¥","å·²æŠ¥å¾…å›","å·²å›"].map(x => `<option value="${x}" ${r.status===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div style="grid-column: span 2; display:flex; justify-content:flex-end; align-items:end;">
            <button class="btn-ghost" data-k="remove">åˆ é™¤</button>
          </div>

          <div style="grid-column: span 6;">
            <div class="mini">åº”æŠ¥é”€äºº/éƒ¨é—¨/å¯¹æ–¹</div>
            <input type="text" value="${escapeAttr(r.payer||"")}" data-k="payer" />
          </div>
          <div style="grid-column: span 6;">
            <div class="mini">é¢„è®¡å›æ¬¾ï¼ˆå¯é€‰ï¼‰</div>
            <input type="text" value="${escapeAttr(r.expected||"")}" data-k="expected" placeholder="æ¯”å¦‚ï¼š1æœˆ30æ—¥å‰" />
          </div>
        </div>
        <div style="margin-top:10px;">
          <div class="mini">å¤‡æ³¨</div>
          <textarea data-k="note">${escapeHtml(r.note||"")}</textarea>
        </div>
      `;

      item.querySelector('[data-k="date"]').addEventListener("change",(e)=>{ r.date = e.target.value; markDirty("æ”¹æŠ¥è´¦æ—¥æœŸ"); });
      {
        const amtEl = item.querySelector('[data-k="amount"]');
        amtEl.addEventListener("input", (e)=>{ r._raw = e.target.value; markDirty("è¾“å…¥æŠ¥è´¦é‡‘é¢"); });
        const commit = () => { r.amount = parseMoney(r._raw); r._raw = String(r._raw ?? r.amount); save(); };
        amtEl.addEventListener("change", commit);
        amtEl.addEventListener("blur", commit);
        amtEl.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") { ev.preventDefault(); amtEl.blur(); } });
      }
      item.querySelector('[data-k="purpose"]').addEventListener("input",(e)=>{ r.purpose = e.target.value; markDirty("æ”¹æŠ¥è´¦ç”¨é€”"); });
      item.querySelector('[data-k="status"]').addEventListener("change",(e)=>{ r.status = e.target.value; markDirty("æ”¹æŠ¥è´¦çŠ¶æ€"); });
      item.querySelector('[data-k="payer"]').addEventListener("input",(e)=>{ r.payer = e.target.value; markDirty("æ”¹æŠ¥è´¦å¯¹è±¡"); });
      item.querySelector('[data-k="expected"]').addEventListener("input",(e)=>{ r.expected = e.target.value; markDirty("æ”¹æŠ¥è´¦é¢„è®¡"); });
      item.querySelector('[data-k="note"]').addEventListener("input",(e)=>{ r.note = e.target.value; markDirty("æ”¹æŠ¥è´¦å¤‡æ³¨"); });
      item.querySelector('[data-k="remove"]').addEventListener("click",()=>{
        S.reimburse = (S.reimburse||[]).filter(x => x.id !== r.id);
        markDirty("åˆ é™¤æŠ¥è´¦");
        scheduleRender(false);
      });

      list.appendChild(item);
    });
  }

  function addReim(){
    S.reimburse = S.reimburse || [];
    S.reimburse.push({ id:uid(), date:S.settleDate, amount:0, purpose:"å«ä»˜æŠ¥è´¦", payer:"", expected:"", status:"æœªæŠ¥", note:"" });
    markDirty("æ–°å¢æŠ¥è´¦");
    scheduleRender(false);
  }

  // ---------------------
  // ç”¨é€” -> é“¶è¡Œå¡
  // ---------------------
  function drawBucketBankList(){
    const list = document.getElementById("bucketBankList");
    const bankMap = bankByIdMap();
    list.innerHTML = "";

    const buckets = allBuckets(S);

    buckets.forEach(b => {
      const cur = S.bucketBank[b.key];
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div style="min-width: 220px;">
            <div style="font-weight:900; font-size:16px;">${b.emoji} ${escapeHtml(b.name)}</div>
            <div class="mini">å½“å‰ï¼š${escapeHtml(bankMap[cur]?.name||"æœªçŸ¥")}ï¼ˆ${escapeHtml(bankMap[cur]?.last4||"----")}ï¼‰</div>
          </div>
          <div style="flex:1; min-width: 240px;">
            <select data-k="sel">
              ${(S.banks||[]).map(bk => `<option value="${bk.id}" ${bk.id===cur?"selected":""}>${escapeHtml(bk.name)}ï¼ˆæ ‡è¯† ${escapeHtml(bk.last4)}ï¼‰</option>`).join("")}
            </select>
          </div>
        </div>
      `;
      div.querySelector('[data-k="sel"]').addEventListener("change",(e)=>{
        S.bucketBank[b.key] = e.target.value;
        markDirty("æ”¹ç”¨é€”é“¶è¡Œå¡");
        scheduleRender(false);
      });
      list.appendChild(div);
    });
  }

  // ---------------------
  // è½¬è´¦æ¸…å•
  // ---------------------
  function drawTransferArea(grouped, bankMap){
    const area = document.getElementById("transferArea");
    const p = progress();
    area.innerHTML = `<div class="hint">è¿›åº¦ï¼šå·²å‹¾é€‰ ${p.checked}/${p.total}</div>`;

    Object.keys(CATEGORY).forEach(cat => {
      const bankIds = Object.keys(grouped[cat]||{});
      if(bankIds.length===0) return;

      const sec = document.createElement("div");
      sec.className = "item";
      sec.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div style="font-size:18px; font-weight:900;">${CATEGORY[cat]}</div>
          <div class="mini">ï¼ˆæŒ‰é“¶è¡Œå¡åˆ†ç»„ï¼‰</div>
        </div>
      `;

      const inner = document.createElement("div");
      inner.style.marginTop = "10px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "10px";

      bankIds.forEach(bankId => {
        const lns = grouped[cat][bankId];
        const bk = bankMap[bankId] || {name:"æœªçŸ¥é“¶è¡Œå¡", last4:"----"};
        const subtotal = trunc2(lns.reduce((a,x)=>a+x.amount,0));

        const box = document.createElement("div");
        box.className = "item";
        box.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:900;">${escapeHtml(bk.name)}ï¼ˆæ ‡è¯† ${escapeHtml(bk.last4)}ï¼‰</div>
              <div class="mini">å»ºè®®ï¼šä¸€å¼ å¡ä¸€æ¬¡æ€§è½¬å®Œ</div>
            </div>
            <div style="font-size:20px; font-weight:900;">Â¥ ${fmt(subtotal)}</div>
          </div>
          <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" data-k="lines"></div>
        `;

        const linesWrap = box.querySelector('[data-k="lines"]');
        lns.forEach(ln => {
          const line = document.createElement("div");
          line.className = "checkline";
          line.innerHTML = `
            <label style="min-width:0;">
              <input type="checkbox" ${S.transferChecks[ln.checkKey] ? "checked":""} />
              <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                <b>${escapeHtml(ln.bucketName)}</b>
                <span class="mini">ï¼ˆ${CATEGORY[cat]} â†’ ${escapeHtml(bk.last4)}ï¼‰</span>
              </span>
            </label>
            <div style="font-weight:900;">Â¥ ${fmt(ln.amount)}</div>
          `;
          line.querySelector('input').addEventListener("change",(e)=>{
            S.transferChecks[ln.checkKey] = e.target.checked;
            markDirty("å‹¾é€‰è½¬è´¦");
            scheduleRender(false);
          });
          linesWrap.appendChild(line);
        });

        inner.appendChild(box);
      });

      sec.appendChild(inner);
      area.appendChild(sec);
    });
  }

  // ---------------------
  // å›¾è¡¨
  // ---------------------
  function drawCharts(t, allocT){
    const pieCtx = document.getElementById("pieCanvas");
    const barCtx = document.getElementById("barCanvas");
    if(!pieCtx || !barCtx) return;

    const buckets = allBuckets(S);
    const pieData = buckets.map(b => allocT[b.key]||0);
    const pieLabels = buckets.map(b => `${b.emoji}${b.name}`);

    const barData = [t.FIXED||0, t.BIZ||0, t.OTHER||0];
    const barLabels = [CATEGORY.FIXED, CATEGORY.BIZ, CATEGORY.OTHER];

    if(pieChart) pieChart.destroy();
    if(barChart) barChart.destroy();

    const piePercentPlugin = {
      id: 'piePercentLabels',
      afterDatasetsDraw(chart){
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        if(!meta || !meta.data) return;

        const ds = chart.data.datasets[0];
        const vals = (ds.data||[]).map(v => Number(v)||0);
        const total = vals.reduce((a,b)=>a+b,0);
        if(total <= 0) return;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji"';
        ctx.fillStyle = 'rgba(17,24,39,.78)';

        meta.data.forEach((arc, i) => {
          const v = vals[i] || 0;
          if(v <= 0) return;
          const pct = v / total * 100;
          if(pct < 4) return;

          const props = arc.getProps(['startAngle','endAngle','outerRadius','innerRadius','x','y'], true);
          const angle = (props.startAngle + props.endAngle) / 2;
          const r = (props.innerRadius + props.outerRadius) / 2;
          const x = props.x + Math.cos(angle) * r;
          const y = props.y + Math.sin(angle) * r;
          ctx.fillText(`${pct.toFixed(pct < 10 ? 1 : 0)}%`, x, y);
        });

        ctx.restore();
      }
    };

    pieChart = new Chart(pieCtx, {
      type: "pie",
      data: {
        labels: pieLabels,
        datasets: [{ data: pieData }]
      },
      plugins: [piePercentPlugin],
      options:{
        responsive:true,
        plugins:{
          tooltip:{
            callbacks:{
              label:(ctx)=> ` ${ctx.label}: Â¥ ${fmt(ctx.parsed)}`
            }
          },
          legend:{
            display:true,
            position:'bottom',
            labels:{ boxWidth: 12, font:{ size: 12 } }
          }
        }
      }
    });

    barChart = new Chart(barCtx, {
      type: "bar",
      data: {
        labels: barLabels,
        datasets: [{ label: "é‡‘é¢", data: barData }]
      },
      options:{
        responsive:true,
        plugins:{
          tooltip:{ callbacks:{ label:(ctx)=> ` Â¥ ${fmt(ctx.parsed.y)}` } },
          legend:{ display:true }
        },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  // ---------------------
  // è‡ªå®šä¹‰åˆ†é…é¡¹
  // ---------------------
  function addCustomBucket(){
    const name = prompt("æ–°å¢åˆ†é…é¡¹åç§°ï¼š", "æ–°åˆ†é…é¡¹");
    if(!name || !name.trim()) return;
    const emoji = prompt("ç»™å®ƒé…ä¸ªè¡¨æƒ…ï¼ˆå¯é€‰ï¼‰ï¼š", "ğŸ¯") || "ğŸ¯";
    const key = `CUST_${uid()}`;
    S.customBuckets.push({ key, name: name.trim(), emoji: (emoji||"ğŸ¯").trim() || "ğŸ¯" });

    const fallback = S.banks?.[0]?.id;
    if(fallback) S.bucketBank[key] = fallback;

    (S.schemes||[]).forEach(s => {
      s.ratios = s.ratios || {};
      if(s.ratios[key]==null) s.ratios[key] = 0;
    });

    markDirty("æ–°å¢åˆ†é…é¡¹");
    scheduleRender(false);
  }

  function deleteCustomBucket(key){
    if(!confirm("ç¡®è®¤åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰åˆ†é…é¡¹ï¼Ÿï¼ˆä¼šä»æ‰€æœ‰æ¯”ä¾‹æ–¹æ¡ˆä¸­ç§»é™¤ï¼‰")) return;
    S.customBuckets = (S.customBuckets||[]).filter(b => b.key !== key);
    delete S.bucketBank[key];
    (S.schemes||[]).forEach(s => { if(s.ratios) delete s.ratios[key]; });
    markDirty("åˆ é™¤åˆ†é…é¡¹");
    scheduleRender(false);
  }

  // ---------------------
  // æ¯”ä¾‹ç¼–è¾‘æ¨¡æ€æ¡†
  // ---------------------
  let modalCtx = { cat:null, schemeId:null };

  function openRatioModal(cat, schemeId){
    const sch = (S.schemes||[]).find(x => x.id===schemeId);
    if(!sch) return;

    modalCtx = { cat, schemeId };
    ratioModalTitle.textContent = `ç¼–è¾‘æ¯”ä¾‹ï¼š${sch.name}ï¼ˆ${CATEGORY[cat]}ï¼‰`;

    const buckets = allBuckets(S);
    ratioGrid.innerHTML = buckets.map(b => {
      const v = Number((sch.ratios && sch.ratios[b.key]) || 0);
      return `
        <div class="ratio-cell">
          <div class="topline">
            <div style="font-weight:900;">${b.emoji} ${escapeHtml(b.name)}</div>
            <div class="mini">0~1</div>
          </div>
          <input type="number" step="0.001" value="${v}" data-bucket="${b.key}" />
          <div class="mini" style="margin-top:6px;">ä¾‹ï¼š0.2=20%</div>
        </div>
      `;
    }).join("");

    ratioGrid.querySelectorAll('input[data-bucket]').forEach(inp => {
      inp.addEventListener('input', () => updateRatioSumPreview());
    });

    updateRatioSumPreview();
    ratioModalMask.style.display = 'flex';
  }

  function closeRatioModal(){ ratioModalMask.style.display = 'none'; }

  function updateRatioSumPreview(){
    let sum = 0;
    ratioGrid.querySelectorAll('input[data-bucket]').forEach(inp => {
      const v = Number(inp.value||0);
      if(!Number.isFinite(v)) return;
      sum += v;
    });
    ratioSumText.textContent = sum.toFixed(3);
  }

  ratioModalClose.addEventListener('click', closeRatioModal);
  ratioModalMask.addEventListener('click', (e) => { if(e.target === ratioModalMask) closeRatioModal(); });

  ratioModalSave.addEventListener('click', () => {
    const sch = (S.schemes||[]).find(x => x.id===modalCtx.schemeId);
    if(!sch) return;
    sch.ratios = sch.ratios || {};

    ratioGrid.querySelectorAll('input[data-bucket]').forEach(inp => {
      const key = inp.dataset.bucket;
      const v = Number(inp.value||0);
      sch.ratios[key] = Number.isFinite(v) ? v : 0;
    });

    markDirty("ç¼–è¾‘æ¯”ä¾‹");
    closeRatioModal();
    scheduleRender(false);
  });

  // ---------------------
  // å†å²é¡µ / é“¶è¡Œå¡é¡µ / è§„åˆ™ä¸­å¿ƒï¼ˆé€»è¾‘ä¸å˜ï¼Œä»…æŠŠ save() æ”¹ä¸º markDirty()ï¼‰
  // ---------------------
  function renderHistory(){
    const listHtml = (S.history||[]).map(h => {
      const t = { FIXED:0, BIZ:0, OTHER:0 };
      (h.incomeItems||[]).forEach(it => { if(!it.include) return; t[it.category]+=Number(it.amount)||0; });
      const total = t.FIXED+t.BIZ+t.OTHER;
      return `
        <div class="item">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
            <div>
              <div style="font-size:18px; font-weight:900;">ğŸ“Œ ${escapeHtml(h.settleDate)}</div>
              <div class="mini">æ€»æ”¶å…¥ï¼šÂ¥ ${fmt(total)} ï½œ åˆ›å»ºï¼š${new Date(h.createdAt).toLocaleString()}</div>
              ${h.globalNote ? `<div style="margin-top:8px;">å¤‡æ³¨ï¼š${escapeHtml(h.globalNote)}</div>` : ``}
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn-primary" data-act="load" data-id="${h.id}">è½½å…¥</button>
              <button class="btn-ghost" data-act="del" data-id="${h.id}">åˆ é™¤</button>
            </div>
          </div>
          <div class="hr"></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div class="badge">å·¥èµ„ï¼šÂ¥ ${fmt(t.FIXED)}</div>
            <div class="badge">ä¸šåŠ¡ï¼šÂ¥ ${fmt(t.BIZ)}</div>
            <div class="badge">å…¶ä»–ï¼šÂ¥ ${fmt(t.OTHER)}</div>
            <div class="badge">æ€»è®¡ï¼šÂ¥ ${fmt(total)}</div>
          </div>
        </div>
      `;
    }).join("");

    page.innerHTML = `
      <div class="card">
        <h2>å†å²æ•°æ®</h2>
      </div>
      <div class="card">
        ${(S.history||[]).length ? `<div class="list">${listHtml}</div>` : `<div style="text-align:center; padding:30px;" class="hint">è¿˜æ²¡æœ‰å†å²è®°å½•ï½å»â€œæœ¬æ¬¡ç»“ç®—â€ç‚¹ã€ä¿å­˜åˆ°å†å²ã€‘ğŸ—‚</div>`}
      </div>
    `;

    page.querySelectorAll('button[data-act]').forEach(btn => {
      btn.addEventListener("click", () => {
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        if(act==="del"){
          if(!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡å†å²ï¼Ÿ")) return;
          S.history = (S.history||[]).filter(x => x.id !== id);
          markDirty("åˆ é™¤å†å²");
          render();
        }else if(act==="load"){
          const h = (S.history||[]).find(x => x.id===id);
          if(!h) return;
          S.settleDate = h.settleDate;
          S.globalNote = h.globalNote;
          S.banks = h.banks;
          S.bucketBank = h.bucketBank;
          S.schemes = h.schemes;
          S.incomeItems = h.incomeItems;
          S.reimburse = h.reimburse;
          S.transferChecks = h.transferChecks || {};
          S.templateB64 = (h.templateB64 ?? S.templateB64);
          S.customBuckets = (h.customBuckets ?? S.customBuckets ?? []);

          settleDateEl.value = S.settleDate;
          ensureConsistency();
          markDirty("è½½å…¥å†å²");

          tab="current";
          document.querySelectorAll('.nav button[data-tab]').forEach(x => x.classList.remove('active'));
          document.querySelector('.nav button[data-tab="current"]').classList.add('active');
          render();
        }
      });
    });
  }

  function renderBanks(){
    page.innerHTML = `
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
          <div>
            <h2>é“¶è¡Œå¡ç®¡ç†</h2>
          </div>
          <button class="btn-primary" id="addBank">+ æ–°å¢é“¶è¡Œå¡</button>
        </div>
      </div>
      <div class="card">
        <div class="list" id="bankList"></div>
      </div>
    `;

    const list = document.getElementById("bankList");
    list.innerHTML = "";

    (S.banks||[]).forEach(bk => {
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="row">
          <div style="grid-column: span 7;">
            <div class="mini">åç§°</div>
            <input type="text" value="${escapeAttr(bk.name)}" data-k="name" />
          </div>
          <div style="grid-column: span 3;">
            <div class="mini">æ ‡è¯†ï¼ˆå°¾å·/å°å­©ï¼‰</div>
            <input type="text" value="${escapeAttr(bk.last4)}" data-k="last4" />
          </div>
          <div style="grid-column: span 2; display:flex; justify-content:flex-end; align-items:end;">
            <button class="btn-ghost" data-k="del">åˆ é™¤</button>
          </div>
        </div>
      `;

      item.querySelector('[data-k="name"]').addEventListener("input",(e)=>{ bk.name=e.target.value; markDirty("æ”¹é“¶è¡Œå¡å"); });
      item.querySelector('[data-k="last4"]').addEventListener("input",(e)=>{ bk.last4=e.target.value; markDirty("æ”¹é“¶è¡Œå¡æ ‡è¯†"); });
      item.querySelector('[data-k="del"]').addEventListener("click",()=>{
        if(!confirm("ç¡®è®¤åˆ é™¤è¿™å¼ å¡ï¼Ÿ")) return;
        const fallback = (S.banks||[]).find(x => x.id!==bk.id);
        if(!fallback){ alert("è‡³å°‘ä¿ç•™ä¸€å¼ é“¶è¡Œå¡"); return; }

        Object.keys(S.bucketBank||{}).forEach(k => {
          if(S.bucketBank[k]===bk.id) S.bucketBank[k]=fallback.id;
        });
        S.banks = (S.banks||[]).filter(x => x.id!==bk.id);
        markDirty("åˆ é™¤é“¶è¡Œå¡");
        render();
      });

      list.appendChild(item);
    });

    document.getElementById("addBank").onclick = () => {
      S.banks.push({ id:uid(), name:"æ–°é“¶è¡Œå¡", last4:"0000" });
      markDirty("æ–°å¢é“¶è¡Œå¡");
      render();
    };
  }

  function renderRules(){
    ensureConsistency();

    page.innerHTML = `
      <div class="card">
        <h2>è§„åˆ™ä¸­å¿ƒï¼ˆæ¯”ä¾‹æ–¹æ¡ˆï¼‰</h2>
        <div class="mini">ä½ ä»¥ååŠ æ–°é¡¹ç›®ã€æ”¹æ¯”ä¾‹ï¼Œéƒ½åœ¨è¿™é‡Œä¸€æŠŠæ¢­ã€‚</div>
      </div>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0;">è‡ªå®šä¹‰åˆ†é…é¡¹</h2>
            <div class="mini">ï¼ˆä¼šåŒæ­¥å‡ºç°åœ¨ï¼šåˆ†é…æ€»è§ˆ / ç”¨é€”â†’é“¶è¡Œå¡ / å„æ¯”ä¾‹æ–¹æ¡ˆï¼‰</div>
          </div>
          <button class="btn-primary" id="addBucket2">â• æ–°å¢åˆ†é…é¡¹</button>
        </div>
        <div class="hr"></div>
        <div id="customBucketList" class="list"></div>
      </div>
      <div id="schemeWrap"></div>
    `;

    document.getElementById('addBucket2').addEventListener('click', addCustomBucket);

    const cList = document.getElementById('customBucketList');
    cList.innerHTML = (S.customBuckets||[]).length
      ? (S.customBuckets||[]).map(b => `
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:900;">${escapeHtml(b.emoji||'ğŸ¯')} ${escapeHtml(b.name)}</div>
              <button class="btn-ghost" data-del="${b.key}">åˆ é™¤</button>
            </div>
          </div>
        `).join('')
      : `<div class="hint" style="text-align:center; padding:12px;">å½“å‰æ²¡æœ‰è‡ªå®šä¹‰åˆ†é…é¡¹ï½</div>`;

    cList.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', () => deleteCustomBucket(btn.dataset.del));
    });

    const wrap = document.getElementById("schemeWrap");
    wrap.innerHTML = "";

    Object.keys(CATEGORY).forEach(cat => {
      const list = (S.schemes||[]).filter(s => s.category===cat);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0;">${CATEGORY[cat]} çš„æ–¹æ¡ˆ</h2>
            <div class="mini">æ¯æ¡æ”¶å…¥éƒ½èƒ½é€‰ä¸åŒæ–¹æ¡ˆï¼›ä¹Ÿèƒ½åœ¨æ”¶å…¥æ˜ç»†é‡Œâ€œæ–°å¢è‡ªå®šä¹‰æ¯”ä¾‹â€</div>
          </div>
          <button class="btn-ghost" data-act="addScheme">+ æ–°å¢æ–¹æ¡ˆ</button>
        </div>
        <div class="hr"></div>
        <div class="list" data-k="list"></div>
      `;

      card.querySelector('[data-act="addScheme"]').addEventListener('click', ()=>{
        const nm = prompt("æ–°æ–¹æ¡ˆåç§°ï¼š", `${CATEGORY[cat]}-æ–°æ–¹æ¡ˆ`);
        const buckets = allBuckets(S);
        const ratios = Object.fromEntries(buckets.map(b => [b.key, 0]));
        S.schemes.push({ id:uid(), category:cat, name:(nm&&nm.trim())?nm.trim():"æ–°åˆ†é…æ–¹æ¡ˆ", ratios });
        markDirty("æ–°å¢æ–¹æ¡ˆ");
        render();
      });

      const listEl = card.querySelector('[data-k="list"]');

      list.forEach(s => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="flex:1; min-width: 260px;">
              <div class="mini">æ–¹æ¡ˆåç§°</div>
              <input type="text" value="${escapeAttr(s.name)}" data-k="name" />
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn-ghost" data-k="edit">ç¼–è¾‘æ¯”ä¾‹</button>
              <button class="btn-ghost" data-k="del">åˆ é™¤</button>
            </div>
          </div>
        `;

        item.querySelector('[data-k="name"]').addEventListener('input', (e)=>{ s.name=e.target.value; markDirty("æ”¹æ–¹æ¡ˆå"); });
        item.querySelector('[data-k="edit"]').addEventListener('click', ()=> openRatioModal(cat, s.id));

        item.querySelector('[data-k="del"]').addEventListener('click', ()=>{
          if(!confirm("ç¡®è®¤åˆ é™¤æ–¹æ¡ˆï¼Ÿï¼ˆè‹¥æ”¶å…¥æ¡ç›®æ­£åœ¨ä½¿ç”¨å®ƒï¼Œéœ€è¦é‡æ–°é€‰æ‹©æ–¹æ¡ˆï¼‰")) return;
          S.schemes = (S.schemes||[]).filter(x => x.id !== s.id);
          const fallback = (S.schemes||[]).find(x => x.category===cat);
          (S.incomeItems||[]).forEach(it => {
            if(it.schemeId===s.id){ it.schemeId = fallback ? fallback.id : it.schemeId; }
          });
          markDirty("åˆ é™¤æ–¹æ¡ˆ");
          render();
        });

        listEl.appendChild(item);
      });

      wrap.appendChild(card);
    });
  }

  // ---------------------
  // å¯¼å‡º Excelï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼‰
  // ---------------------
  function exportExcel(){
    const t = totalsByCategory();
    const allocT = allocatedTotal();
    const lines = transferLines();
    const bankMap = bankByIdMap();

    try{
      if(S.templateB64){
        const buf = b64ToArrayBuffer(S.templateB64);
        const wb = XLSX.read(buf, { type:"array" });

        upsertSheetKeepStyle(wb, "DATA", buildDataSheet(t, allocT, lines, bankMap));
        upsertSheetKeepStyle(wb, "è½¬è´¦æ¸…å•", buildTransferSheet(lines, bankMap));
        upsertSheetKeepStyle(wb, "å«ä»˜æŠ¥è´¦", buildReimSheet());
        upsertSheetKeepStyle(wb, "é“¶è¡Œå¡", buildBanksSheet());

        smartFillTemplate(wb, t, allocT, lines, bankMap);

        const filename = `${S.settleDate}_ç»“ç®—è¡¨ï¼ˆå°å¦–ï¼‰_æ¨¡æ¿å¯¼å‡º.xlsx`;
        XLSX.writeFile(wb, filename);
      }else{
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, buildDataSheet(t, allocT, lines, bankMap), "DATA");
        XLSX.utils.book_append_sheet(wb, buildTransferSheet(lines, bankMap), "è½¬è´¦æ¸…å•");
        XLSX.utils.book_append_sheet(wb, buildReimSheet(), "å«ä»˜æŠ¥è´¦");
        XLSX.utils.book_append_sheet(wb, buildBanksSheet(), "é“¶è¡Œå¡");
        const filename = `${S.settleDate}_ç»“ç®—è¡¨ï¼ˆå°å¦–ï¼‰.xlsx`;
        XLSX.writeFile(wb, filename);
      }
    }catch(err){
      console.error(err);
      alert(`å¯¼å‡ºå¤±è´¥äº†ï¼ˆä½†ä¸ç”¨æ…Œï¼‰

æŠŠæ§åˆ¶å°é”™è¯¯æˆªå›¾å‘æˆ‘ï¼Œæˆ‘ç»§ç»­ç»™ä½ ä¿®åˆ°ä¸æ»‘ã€‚`);
    }
  }

  // --- Sheet helpersï¼ˆä¿æŒä½ çš„å®ç°ï¼‰
  function upsertSheetKeepStyle(wb, name, wsNew){
    const exists = (wb.SheetNames||[]).includes(name);
    if(!exists){
      wb.Sheets[name] = wsNew;
      wb.SheetNames.push(name);
      return;
    }
    const ws = wb.Sheets[name];
    mergeSheetKeepStyle(ws, wsNew);
  }

  function mergeSheetKeepStyle(targetWs, sourceWs){
    const rng = safeDecodeRange(targetWs['!ref'] || sourceWs['!ref'] || 'A1:A1');
    const clearRange = {
      s: { r: rng.s.r, c: rng.s.c },
      e: { r: Math.max(rng.e.r, 200), c: Math.max(rng.e.c, 40) }
    };
    for(let r=clearRange.s.r; r<=clearRange.e.r; r++){
      for(let c=clearRange.s.c; c<=clearRange.e.c; c++){
        const addr = XLSX.utils.encode_cell({r,c});
        if(targetWs[addr]){ targetWs[addr].v = ""; targetWs[addr].t = 's'; }
      }
    }

    Object.keys(sourceWs).forEach(k => {
      if(k[0] === '!') return;
      const cell = sourceWs[k];
      if(!cell) return;
      const rc = XLSX.utils.decode_cell(k);
      setCellKeepStyle(targetWs, rc, cell.v);
    });

    if(sourceWs['!ref']) targetWs['!ref'] = sourceWs['!ref'];
    if(!targetWs['!cols'] && sourceWs['!cols']) targetWs['!cols'] = sourceWs['!cols'];
  }

  function safeDecodeRange(ref){
    try{ return XLSX.utils.decode_range(ref); }
    catch{ return XLSX.utils.decode_range('A1:A1'); }
  }

  function smartFillTemplate(wb, t, allocT, lines, bankMap){
    const sheets = wb.SheetNames || [];
    if(!sheets.length) return;

    const prefer = sheets.slice().sort((a,b)=>{
      const score = (n)=> (/ç»“ç®—|æ±‡æ€»|æ€»è¡¨/i.test(n) ? 2 : 0) + (/data/i.test(n) ? -1 : 0);
      return score(b)-score(a);
    });

    const metaPairs = [
      ["ç»“ç®—æ—¥æœŸ", S.settleDate],
      ["å¤‡æ³¨", S.globalNote || ""],
      ["å·¥èµ„åˆè®¡", trunc2(t.FIXED)],
      ["ä¸šåŠ¡åˆè®¡", trunc2(t.BIZ)],
      ["å…¶ä»–åˆè®¡", trunc2(t.OTHER)],
      ["æ€»æ”¶å…¥", trunc2(t.FIXED+t.BIZ+t.OTHER)],
    ];

    for(const name of prefer){
      const ws = wb.Sheets[name];
      if(!ws) continue;
      try{ tryWriteKeyValuePairs(ws, metaPairs); }catch{ /* ignore */ }
    }
  }

  function tryWriteKeyValuePairs(ws, pairs){
    const loc = findCellContains(ws, "ç»“ç®—æ—¥æœŸ");
    if(loc){
      let r = loc.r;
      const c = loc.c;
      pairs.forEach(([k,v], i) => {
        setCellKeepStyle(ws, {r:r+i, c:c}, k);
        setCellKeepStyle(ws, {r:r+i, c:c+1}, v);
      });
      return true;
    }
    pairs.forEach(([k,v], i) => {
      setCellKeepStyle(ws, {r:0+i, c:0}, k);
      setCellKeepStyle(ws, {r:0+i, c:1}, v);
    });
    return false;
  }

  function findCellContains(ws, text){
    const grid = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, blankrows:false });
    for(let r=0; r<Math.min(grid.length, 160); r++){
      const row = grid[r] || [];
      for(let c=0; c<Math.min(row.length, 160); c++){
        const v = String(row[c]||"");
        if(v.includes(text)) return { r, c };
      }
    }
    return null;
  }

  function setCellKeepStyle(ws, rc, value){
    const addr = XLSX.utils.encode_cell(rc);
    const old = ws[addr];
    if(old){
      old.v = value;
      old.t = (typeof value === 'number') ? 'n' : 's';
      return;
    }
    ws[addr] = { v: value, t: (typeof value === 'number') ? 'n' : 's' };
  }

  function buildDataSheet(t, allocT, lines, bankMap){
    const buckets = allBuckets(S);
    const rows = [];
    rows.push(["ç»“ç®—æ—¥æœŸ", S.settleDate, "", "å¤‡æ³¨", S.globalNote || ""]);
    rows.push([]);
    rows.push(["ç±»åˆ«æ±‡æ€»", "é‡‘é¢"]);
    rows.push([CATEGORY.FIXED, trunc2(t.FIXED)]);
    rows.push([CATEGORY.BIZ, trunc2(t.BIZ)]);
    rows.push([CATEGORY.OTHER, trunc2(t.OTHER)]);
    rows.push(["æ€»è®¡", trunc2(t.FIXED+t.BIZ+t.OTHER)]);
    rows.push([]);
    rows.push(["åˆ†é…æ€»è§ˆ", "é‡‘é¢", "å¯¹åº”é“¶è¡Œå¡", "é“¶è¡Œå¡æ ‡è¯†"]);
    buckets.forEach(b => {
      const bankId = S.bucketBank[b.key];
      const bk = bankMap[bankId] || {};
      rows.push([`${b.emoji} ${b.name}`, trunc2(allocT[b.key]||0), bk.name||"", bk.last4||""]);
    });
    rows.push([]);
    rows.push(["è½¬è´¦æ¸…å•", "ï¼ˆåŒæ–‡ä»¶ä¸­çš„ è½¬è´¦æ¸…å• sheetï¼‰"]);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:20},{wch:14},{wch:22},{wch:14},{wch:40}];
    return ws;
  }

  function buildTransferSheet(lines, bankMap){
    const rows = [];
    rows.push(["ç»“ç®—æ—¥æœŸ", S.settleDate]);
    rows.push([]);
    rows.push(["ç±»åˆ«","é“¶è¡Œå¡","æ ‡è¯†","åˆ†é…é¡¹","é‡‘é¢","æ˜¯å¦å·²è½¬"]);
    lines.forEach(ln => {
      const bk = bankMap[ln.bankId] || {};
      rows.push([
        CATEGORY[ln.category],
        bk.name||"",
        bk.last4||"",
        ln.bucketName,
        trunc2(ln.amount),
        S.transferChecks[ln.checkKey] ? "å·²è½¬" : "æœªè½¬"
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:16},{wch:18},{wch:10},{wch:34},{wch:12},{wch:12}];
    return ws;
  }

  function buildReimSheet(){
    const rows = [];
    rows.push(["å«ä»˜æŠ¥è´¦ï¼ˆä¸å‚ä¸åˆ†è´¦ï¼‰"]);
    rows.push([]);
    rows.push(["æ—¥æœŸ","é‡‘é¢","ç”¨é€”","åº”æŠ¥é”€äºº/éƒ¨é—¨","é¢„è®¡å›æ¬¾","çŠ¶æ€","å¤‡æ³¨"]);
    (S.reimburse||[]).forEach(r => {
      rows.push([r.date, trunc2(r.amount||0), r.purpose||"", r.payer||"", r.expected||"", r.status||"", r.note||""]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:12},{wch:10},{wch:18},{wch:18},{wch:14},{wch:10},{wch:40}];
    return ws;
  }

  function buildBanksSheet(){
    const rows = [];
    rows.push(["é“¶è¡Œå¡æ¸…å•"]);
    rows.push([]);
    rows.push(["åç§°","æ ‡è¯†(å°¾å·/å°å­©)","id"]);
    (S.banks||[]).forEach(b => rows.push([b.name,b.last4,b.id]));
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:22},{wch:16},{wch:18}];
    return ws;
  }

  // ---------------------
  // base64 å·¥å…·
  // ---------------------
  function arrayBufferToB64(buf){
    let binary = "";
    const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    for(let i=0;i<bytes.length;i+=chunk){
      binary += String.fromCharCode(...bytes.subarray(i,i+chunk));
    }
    return btoa(binary);
  }
  function b64ToArrayBuffer(b64){
    const bin = atob(b64);
    const len = bin.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
    return bytes.buffer;
  }

  // ---------------------
  // å®‰å…¨è½¬ä¹‰
  // ---------------------
  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function escapeAttr(str){
    return escapeHtml(str).replace(/[
]+/g, " ");
  }

  // ---------------------
  // äº‘åŒæ­¥ï¼ˆGitHub Contents APIï¼‰
  // ---------------------
  const CLOUD_CFG_KEY = "xiaoyao_money_cloud_cfg_v1";

  // âœ… å®æ—¶åŒæ­¥è¿è¡Œæ—¶ç¼“å­˜ï¼ˆETag/shaï¼‰
  let cloudEtag = null;
  let cloudSha = null;
  let cloudAutoTimer = null;
  let pendingConflict = null; // {remotePayload, remoteSha, remoteEtag}

  function loadCloudCfg(){
    try{
      const raw = localStorage.getItem(CLOUD_CFG_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }
  function saveCloudCfg(cfg){
    localStorage.setItem(CLOUD_CFG_KEY, JSON.stringify(cfg));
  }

  function setCloudStatus(text, ok=null){
    const el = document.getElementById('cloudStatus');
    if(!el) return;
    el.textContent = text;
    el.style.opacity = '0.9';
    if(ok === true) el.style.color = 'var(--ok)';
    else if(ok === false) el.style.color = 'var(--danger)';
    else el.style.color = 'var(--muted)';
  }

  function openCloudModal(){
    const mask = document.getElementById('cloudModalMask');
    const cfg = loadCloudCfg() || {
      enabled:false,
      owner:"",
      repo:"",
      branch:"main",
      path:"data.json",
      token:"",
    };

    document.getElementById('cloudEnabled').checked = !!cfg.enabled;
    document.getElementById('cloudOwner').value = cfg.owner || "wuxyfree-dev";
    document.getElementById('cloudRepo').value = cfg.repo || "money";
    document.getElementById('cloudBranch').value = cfg.branch || "main";
    document.getElementById('cloudPath').value = cfg.path || "data.json";
    document.getElementById('cloudToken').value = cfg.token || "";

    document.getElementById('cloudModalStatus').textContent = cfg.enabled ? "å·²å¯ç”¨ï¼ˆæœ¬æœºï¼‰" : "æœªå¯ç”¨";
    mask.style.display = 'flex';
  }
  function closeCloudModal(){
    const mask = document.getElementById('cloudModalMask');
    mask.style.display = 'none';
  }

  function getCloudCfgFromModal(){
    return {
      enabled: document.getElementById('cloudEnabled').checked,
      owner: (document.getElementById('cloudOwner').value||"").trim(),
      repo: (document.getElementById('cloudRepo').value||"").trim(),
      branch: (document.getElementById('cloudBranch').value||"main").trim() || "main",
      path: (document.getElementById('cloudPath').value||"data.json").trim() || "data.json",
      token: (document.getElementById('cloudToken').value||"").trim(),
    };
  }

  async function ghFetch(url, cfg, extraHeaders={}){
    const headers = {
      'Accept': 'application/vnd.github+json',
      'Authorization': `Bearer ${cfg.token}`,
      'X-GitHub-Api-Version': '2022-11-28',
      ...extraHeaders,
    };
    const res = await fetch(url, { headers });
    return res;
  }

  async function ghGetFile(cfg, useEtag=true){
    const url = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch)}`;
    const extra = {};
    if(useEtag && cloudEtag) extra['If-None-Match'] = cloudEtag;

    const res = await ghFetch(url, cfg, extra);

    if(res.status === 304){
      return { notModified:true };
    }

    const text = await res.text();
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch{ json = null; }

    if(!res.ok){
      const msg = (json && (json.message || json.error)) ? (json.message || json.error) : text;
      const err = new Error(`GitHub API å¤±è´¥ï¼š${res.status} ${res.statusText} - ${msg}`);
      err.status = res.status;
      throw err;
    }

    cloudEtag = res.headers.get('etag') || cloudEtag;
    cloudSha = json && json.sha ? json.sha : cloudSha;

    return { notModified:false, json };
  }

  async function ghPutFile(cfg, contentStr, sha){
    const url = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path}`;
    const body = {
      message: `chore: sync money data (${new Date().toISOString()})`,
      content: btoa(unescape(encodeURIComponent(contentStr))),
      branch: cfg.branch,
    };
    if(sha) body.sha = sha;

    const res = await fetch(url, {
      method: 'PUT',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${cfg.token}`,
        'X-GitHub-Api-Version': '2022-11-28',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body)
    });

    const text = await res.text();
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch{ json = null; }

    if(!res.ok){
      const msg = (json && (json.message || json.error)) ? (json.message || json.error) : text;
      const err = new Error(`GitHub å†™å…¥å¤±è´¥ï¼š${res.status} ${res.statusText} - ${msg}`);
      err.status = res.status;
      throw err;
    }

    cloudSha = json && json.content && json.content.sha ? json.content.sha : cloudSha;
    return json;
  }

  function buildCloudPayload(){
    return {
      schema: 1,
      updatedAt: Date.now(),
      updatedBy: deviceId,
      data: stripTransientState(S),
    };
  }

  function applyCloudPayload(payload){
    if(!payload || !payload.data) return false;

    const keepTemplate = S.templateB64 || null;

    S = payload.data;
    S.templateB64 = keepTemplate;
    S.cloudUpdatedAt = payload.updatedAt || Date.now();
    if(!S.lastLocalUpdateAt) S.lastLocalUpdateAt = payload.updatedAt || Date.now();

    ensureConsistency();
    settleDateEl.value = S.settleDate || todayStr();

    // âœ… æ‹‰åˆ°äº‘ç«¯åï¼Œæœ¬åœ°è§†ä¸ºâ€œå¹²å‡€â€
    localDirty = false;
    lastSavedHash = fastHash(snapshotForHash());

    save();
    return true;
  }

  function decodeContent(content){
    // âœ… ä¿®å¤ï¼šreplace æ­£åˆ™è¢«æ–­è¡Œä¼šç›´æ¥ SyntaxError
    const cleaned = String(content||"").replace(/?
/g, '');
    const raw = decodeURIComponent(escape(atob(cleaned)));
    return raw;
  }

  function summarizePayload(payload){
    const d = payload && payload.data ? payload.data : null;
    if(!d) return { total:0, hist:0, updatedAt: payload?.updatedAt || 0 };
    const t = { FIXED:0, BIZ:0, OTHER:0 };
    (d.incomeItems||[]).forEach(it => { if(!it.include) return; t[it.category]+=Number(it.amount)||0; });
    const total = trunc2(t.FIXED+t.BIZ+t.OTHER);
    return { total, hist: (d.history||[]).length, updatedAt: payload.updatedAt||0, by: payload.updatedBy||"" };
  }

  function openConflictModal(remotePayload){
    const localPayload = {
      schema: 1,
      updatedAt: Date.now(),
      updatedBy: deviceId,
      data: stripTransientState(S),
    };

    const a = { kind:"cloud", payload: remotePayload, sum: summarizePayload(remotePayload) };
    const b = { kind:"local", payload: localPayload, sum: summarizePayload(localPayload) };

    const arr = [a,b].sort((x,y)=> (y.sum.updatedAt||0) - (x.sum.updatedAt||0));

    conflictList.innerHTML = arr.map((x, idx)=>{
      const isCloud = x.kind === 'cloud';
      const tag = isCloud ? "â˜ï¸ äº‘ç«¯ç‰ˆæœ¬" : "ğŸ–¥ï¸ æœ¬åœ°ç‰ˆæœ¬";
      const time = x.sum.updatedAt ? new Date(x.sum.updatedAt).toLocaleString() : "æœªçŸ¥";
      const by = x.sum.by ? `ï¼ˆæ¥è‡ªï¼š${escapeHtml(x.sum.by === deviceId ? 'æœ¬æœº' : x.sum.by)}ï¼‰` : "";
      return `
        <div class="item" style="border:1px solid rgba(124,58,237,.18);">
          <label style="display:flex; gap:12px; align-items:flex-start; cursor:pointer;">
            <input type="radio" name="conflictPick" value="${x.kind}" ${idx===0?"checked":""} style="width:20px;height:20px;margin-top:2px;" />
            <div style="flex:1; min-width:0;">
              <div style="font-weight:900; font-size:18px;">${tag}</div>
              <div class="mini" style="margin-top:4px;">æ›´æ–°æ—¶é—´ï¼š${escapeHtml(time)} ${by}</div>
              <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
                <span class="badge">æ€»æ”¶å…¥ï¼šÂ¥ ${fmt(x.sum.total)}</span>
                <span class="badge">å†å²æ¡æ•°ï¼š${x.sum.hist}</span>
              </div>
            </div>
          </label>
        </div>
      `;
    }).join("");

    conflictModalMask.style.display = 'flex';

    conflictUseSelected.onclick = async () => {
      const picked = (document.querySelector('input[name="conflictPick"]:checked')||{}).value;
      if(picked === 'cloud'){
        applyCloudPayload(remotePayload);
        render();
        setCloudStatus(`å·²é‡‡ç”¨äº‘ç«¯ç‰ˆæœ¬ï¼ˆ${new Date(remotePayload.updatedAt||Date.now()).toLocaleString()}ï¼‰`, true);
      }else{
        // é€‰æ‹©æœ¬åœ°ï¼šç›´æ¥æ¨è¦†ç›–äº‘ç«¯
        setCloudStatus('é‡‡ç”¨æœ¬åœ°ç‰ˆæœ¬å¹¶è¦†ç›–äº‘ç«¯â€¦');
        try{
          await cloudPush(loadCloudCfg(), 'å†²çªé€‰æ‹©æœ¬åœ°è¦†ç›–');
        }catch(e){
          console.warn(e);
          alert('è¦†ç›–äº‘ç«¯å¤±è´¥ï¼š' + e.message);
        }
      }
      pendingConflict = null;
      closeConflictModal();
    };
  }

  function closeConflictModal(){
    conflictModalMask.style.display = 'none';
  }

  async function cloudPull(cfg, silent=false){
    if(!cfg || !cfg.enabled) return {ok:false, msg:"æœªå¯ç”¨"};
    if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path || !cfg.token) throw new Error("äº‘åŒæ­¥ä¿¡æ¯ä¸å®Œæ•´");

    if(!silent) setCloudStatus("æ­£åœ¨ä»äº‘ç«¯æ‹‰å–â€¦");

    const got = await ghGetFile(cfg, true);
    if(got.notModified){
      if(!silent) setCloudStatus("äº‘ç«¯æ— å˜åŒ–", true);
      return {ok:true, msg:"304"};
    }

    const file = got.json;
    if(!file || !file.content) throw new Error("äº‘ç«¯æ–‡ä»¶è¯»å–å¤±è´¥ï¼šæ²¡æœ‰ content");

    const raw = decodeContent(file.content);
    const payload = JSON.parse(raw);

    const remoteAt = Number(payload.updatedAt||0);
    const localCloudAt = Number(S.cloudUpdatedAt||0);

    if(remoteAt && remoteAt > localCloudAt + 500){
      // âœ… å†²çªåˆ¤å®šï¼šæœ¬åœ°ä¹Ÿæœ‰æœªæ¨çš„æ”¹åŠ¨ + äº‘ç«¯æ›´æ–°æ›´æ™š
      const localHash = fastHash(snapshotForHash());
      const changedSinceLastHash = localHash !== lastSavedHash;
      const localHasEdits = localDirty || changedSinceLastHash;

      if(localHasEdits){
        pendingConflict = { remotePayload: payload, remoteSha: cloudSha, remoteEtag: cloudEtag };
        setCloudStatus("æ£€æµ‹åˆ°å†²çªï¼Œç­‰å¾…ä½ é€‰æ‹©", false);
        if(!silent) openConflictModal(payload);
        return {ok:false, msg:"conflict"};
      }

      applyCloudPayload(payload);
      setCloudStatus(`å·²æ‹‰å–äº‘ç«¯æœ€æ–°ï¼ˆ${new Date(remoteAt).toLocaleString()}ï¼‰`, true);
      if(!silent) alert(`å·²ä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®âœ…

äº‘ç«¯æ›´æ–°æ—¶é—´ï¼š${new Date(remoteAt).toLocaleString()}`);
      return {ok:true, msg:"å·²è¦†ç›–ä¸ºäº‘ç«¯æœ€æ–°"};
    }

    if(!silent) setCloudStatus("æœ¬åœ°å·²æ˜¯æœ€æ–°", true);
    return {ok:true, msg:"æœ¬åœ°å·²æœ€æ–°"};
  }

  async function cloudPush(cfg, reason="è‡ªåŠ¨ä¸Šä¼ "){
    if(!cfg || !cfg.enabled) return {ok:false, msg:"æœªå¯ç”¨"};
    if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path || !cfg.token) throw new Error("äº‘åŒæ­¥ä¿¡æ¯ä¸å®Œæ•´");

    const now = Date.now();
    if(now - lastPushAt < SYNC_PUSH_MIN_GAP_MS) return {ok:true, msg:"push throttled"};

    // âœ… æ¨ä¹‹å‰å…ˆåšä¸€æ¬¡è½»é‡æ‹‰å–ï¼ˆIf-None-Matchï¼‰ï¼š
    // - 304ï¼šè¯´æ˜äº‘ç«¯æ²¡å˜ -> å®‰å…¨æ¨
    // - 200ï¼šäº‘ç«¯å˜äº† -> å¦‚æœæœ¬åœ°ä¹Ÿå˜äº† -> å†²çª
    try{
      const got = await ghGetFile(cfg, true);
      if(!got.notModified){
        const file = got.json;
        const raw = decodeContent(file.content);
        const payload = JSON.parse(raw);
        const remoteAt = Number(payload.updatedAt||0);

        const localHash = fastHash(snapshotForHash());
        const changedSinceLastHash = localHash !== lastSavedHash;
        const localHasEdits = localDirty || changedSinceLastHash;

        if(remoteAt && remoteAt > Number(S.cloudUpdatedAt||0) + 500 && localHasEdits){
          pendingConflict = { remotePayload: payload, remoteSha: cloudSha, remoteEtag: cloudEtag };
          setCloudStatus("æ£€æµ‹åˆ°å†²çªï¼Œç­‰å¾…ä½ é€‰æ‹©", false);
          openConflictModal(payload);
          return {ok:false, msg:"conflict"};
        }
      }
    }catch(e){
      // å¦‚æœåªæ˜¯ 404ï¼ˆäº‘ç«¯æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ï¼Œåé¢ä¼šåˆ›å»º
      if(!(e && e.status === 404)) throw e;
    }

    setCloudStatus("æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯â€¦");

    // è·å– shaï¼ˆä¸å­˜åœ¨å°±åˆ›å»ºï¼‰
    let sha = cloudSha;
    if(!sha){
      try{
        const got = await ghGetFile(cfg, false);
        if(!got.notModified && got.json && got.json.sha) sha = got.json.sha;
      }catch(e){
        if(!(e && e.status===404)) throw e;
        sha = null;
      }
    }

    const payload = buildCloudPayload();
    const contentStr = JSON.stringify(payload, null, 2);

    await ghPutFile(cfg, contentStr, sha);

    S.cloudUpdatedAt = payload.updatedAt;
    lastPushAt = Date.now();

    // âœ… æ¨æˆåŠŸï¼šæœ¬åœ°å˜æ›´æ¸…é›¶
    localDirty = false;
    lastSavedHash = fastHash(snapshotForHash());

    save();
    setCloudStatus(`å·²åŒæ­¥ï¼ˆ${new Date(payload.updatedAt).toLocaleString()}ï¼‰`, true);
    return {ok:true, msg:`å·²ä¸Šä¼ ï¼š${reason}`};
  }

  function scheduleAutoPush(reason=""){
    const cfg = loadCloudCfg();
    if(!cfg || !cfg.enabled || !cfg.token) return;
    if(document.visibilityState === 'hidden') return; // åå°ä¸æ¨ï¼Œçœèµ„æº

    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(async () => {
      pushTimer = null;
      try{
        // åªæœ‰çœŸçš„å˜äº†æ‰æ¨
        const h = fastHash(snapshotForHash());
        if(h === lastSavedHash) return;
        await cloudPush(cfg, reason || "è‡ªåŠ¨ä¸Šä¼ ");
      }catch(e){
        console.warn(e);
      }
    }, SYNC_PUSH_DEBOUNCE_MS);
  }

  function startRealtimeSyncLoop(){
    stopRealtimeSyncLoop();

    const cfg = loadCloudCfg();
    if(!cfg || !cfg.enabled || !cfg.token) return;

    const tick = async () => {
      if(document.visibilityState === 'hidden') return;
      if(pendingConflict) return; // æœ‰å†²çªå…ˆåˆ«è‡ªåŠ¨è¦†ç›–
      try{
        await cloudPull(cfg, true);
      }catch(e){
        console.warn('auto pull failed', e);
      }
    };

    // ç«‹å³è·‘ä¸€æ¬¡
    tick();

    cloudAutoTimer = setInterval(tick, SYNC_PULL_INTERVAL_MS);
  }

  function stopRealtimeSyncLoop(){
    if(cloudAutoTimer){
      clearInterval(cloudAutoTimer);
      cloudAutoTimer = null;
    }
  }

  function bindCloudUI(){
    const cloudBtn = document.getElementById('cloudBtn');
    const mask = document.getElementById('cloudModalMask');
    const closeBtn = document.getElementById('cloudModalClose');
    const saveBtn = document.getElementById('cloudModalSave');
    const testBtn = document.getElementById('cloudTestBtn');
    const pullBtn = document.getElementById('cloudPullBtn');
    const pushBtn = document.getElementById('cloudPushBtn');
    const modalStatus = document.getElementById('cloudModalStatus');

    if(cloudBtn) cloudBtn.addEventListener('click', openCloudModal);
    if(closeBtn) closeBtn.addEventListener('click', closeCloudModal);
    if(mask) mask.addEventListener('click', (e)=>{ if(e.target===mask) closeCloudModal(); });

    const refreshTopStatus = () => {
      const cfg = loadCloudCfg();
      if(!cfg || !cfg.enabled){
        setCloudStatus('æœªå¯ç”¨');
        stopRealtimeSyncLoop();
        return;
      }
      const t = S.cloudUpdatedAt ? new Date(S.cloudUpdatedAt).toLocaleString() : 'æœªçŸ¥';
      setCloudStatus(`å·²å¯ç”¨ï¼ˆæœ€è¿‘äº‘æ›´ï¼š${t}ï¼‰`, true);
      startRealtimeSyncLoop();
    };

    refreshTopStatus();

    if(testBtn) testBtn.addEventListener('click', async () => {
      const cfg = getCloudCfgFromModal();
      try{
        modalStatus.textContent = 'æµ‹è¯•ä¸­â€¦';
        await ghGetFile(cfg, false);
        modalStatus.textContent = 'è¿æ¥æˆåŠŸ âœ…ï¼ˆèƒ½è¯»åˆ° data.jsonï¼‰';
      }catch(e){
        if(e && e.status===404){
          modalStatus.textContent = 'è¿æ¥æˆåŠŸ âœ…ï¼ˆdata.json ä¸å­˜åœ¨ï¼Œä¸Šä¼ æ—¶ä¼šåˆ›å»ºï¼‰';
        }else{
          modalStatus.textContent = 'è¿æ¥å¤±è´¥ âŒï¼š' + e.message;
        }
      }
    });

    if(pullBtn) pullBtn.addEventListener('click', async () => {
      const cfg = getCloudCfgFromModal();
      try{
        modalStatus.textContent = 'æ‹‰å–ä¸­â€¦';
        await cloudPull(cfg);
        modalStatus.textContent = 'æ‹‰å–å®Œæˆ âœ…';
        refreshTopStatus();
      }catch(e){
        modalStatus.textContent = 'æ‹‰å–å¤±è´¥ âŒï¼š' + e.message;
      }
    });

    if(pushBtn) pushBtn.addEventListener('click', async () => {
      const cfg = getCloudCfgFromModal();
      try{
        modalStatus.textContent = 'ä¸Šä¼ ä¸­â€¦';
        await cloudPush(cfg, 'æ‰‹åŠ¨ä¸Šä¼ ');
        modalStatus.textContent = 'ä¸Šä¼ å®Œæˆ âœ…';
        refreshTopStatus();
      }catch(e){
        modalStatus.textContent = 'ä¸Šä¼ å¤±è´¥ âŒï¼š' + e.message;
      }
    });

    if(saveBtn) saveBtn.addEventListener('click', async () => {
      const cfg = getCloudCfgFromModal();
      if(cfg.enabled){
        if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
          alert('è¯·æŠŠ owner/repo/branch/path å¡«å®Œæ•´');
          return;
        }
        if(!cfg.token){
          alert('è¯·ç²˜è´´ tokenï¼ˆPATï¼‰');
          return;
        }
      }
      saveCloudCfg(cfg);

      try{
        modalStatus.textContent = 'ä¿å­˜å®Œæˆï¼Œå¼€å§‹åŒæ­¥â€¦';
        if(cfg.enabled){
          await cloudPull(cfg, true);
          await cloudPush(cfg, 'ä¿å­˜è®¾ç½®ååŒæ­¥');
          modalStatus.textContent = 'å·²åŒæ­¥ âœ…';
        }else{
          modalStatus.textContent = 'å·²å…³é—­äº‘åŒæ­¥';
        }
        closeCloudModal();
        refreshTopStatus();
        render();
      }catch(e){
        modalStatus.textContent = 'åŒæ­¥å¤±è´¥ âŒï¼š' + e.message;
      }
    });

    return refreshTopStatus;
  }

  // ---------------------
  // Self testsï¼ˆå¢åŠ ï¼šäº‘åŒæ­¥è§£ç /æ­£åˆ™ç¨³å®šæ€§ï¼‰
  // ---------------------
  function runSelfTests(){
    try{
      const t = totalsByCategory();
      const total = trunc2(t.FIXED+t.BIZ+t.OTHER);
      const calc = trunc2((S.incomeItems||[]).filter(x=>x.include).reduce((a,x)=>a+(Number(x.amount)||0),0));
      console.assert(Math.abs(total-calc) < 0.01, "Test1 failed: totals mismatch", {total, calc});

      const allocT = allocatedTotal();
      Object.values(allocT).forEach(v => {
        console.assert((Number(v)||0) >= 0, "Test2 failed: negative allocation", v);
      });

      const x = escapeAttr("a
b");
      console.assert(!(/[
]/.test(x)), "Test3 failed: escapeAttr contains newline", x);

      const cleaned = "YQ==
".replace(/?
/g,'');
      console.assert(cleaned === "YQ==", "Test4 failed: regex clean", cleaned);

      console.assert(typeof XLSX !== 'undefined', 'Test5 failed: XLSX missing');
      console.assert(typeof Chart !== 'undefined', 'Test6 failed: Chart.js missing');
    }catch(e){
      console.warn("SelfTests error:", e);
    }
  }

  // ---------------------
  // é¦–æ¬¡æ¸²æŸ“ + å®æ—¶åŒæ­¥
  // ---------------------
  const refreshCloudTopStatus = bindCloudUI();
  render();
  runSelfTests();

  // æ‰“å¼€é¡µé¢å…ˆæ‹‰ä¸€æ¬¡ï¼ˆè½»é‡ï¼‰
  (async ()=>{
    const cfg = loadCloudCfg();
    if(cfg && cfg.enabled && cfg.token){
      try{ await cloudPull(cfg, true); }catch(e){ console.warn(e); }
      try{ refreshCloudTopStatus && refreshCloudTopStatus(); }catch{}
    }
  })();

  // å‰åå°åˆ‡æ¢ï¼šçœèµ„æº
  document.addEventListener('visibilitychange', () => {
    const cfg = loadCloudCfg();
    if(!cfg || !cfg.enabled) return;
    if(document.visibilityState === 'hidden'){
      stopRealtimeSyncLoop();
    }else{
      startRealtimeSyncLoop();
      // å›åˆ°å‰å°ç«‹å³æ‹‰ä¸€æ¬¡
      cloudPull(cfg, true).catch(()=>{});
    }
  });

  // ç½‘ç»œçŠ¶æ€å˜åŒ–
  window.addEventListener('online', () => {
    const cfg = loadCloudCfg();
    if(cfg && cfg.enabled){
      startRealtimeSyncLoop();
      cloudPull(cfg, true).catch(()=>{});
    }
  });

  window.addEventListener('offline', () => {
    setCloudStatus('ç¦»çº¿ï¼šä»…æœ¬åœ°è®°å½•', false);
  });

})();
</script>

</body>
</html>
